(function(){"use strict";var e={4434:function(e,t,a){var r=a(5130),o=a(657),i=a(6768);const l={id:"app",class:"d-flex flex-column vh-100"},s={class:"d-flex flex-column overflow-hidden"};function n(e,t,a,r,o,n){const c=(0,i.g2)("router-view");return(0,i.uX)(),(0,i.CE)("div",l,[(0,i.Lk)("div",s,[(0,i.bF)(c)])])}var c=a(144),d={name:"App",components:{},setup(){const e=(0,c.KR)(!1),t=(0,c.KR)("載入中..."),a=(0,c.KR)(0),r=(0,c.KR)(!1),o=(0,c.KR)("");return{isLoading:e,loadingText:t,loadingProgress:a,showLoadingProgress:r,loadingSubText:o}}},u=a(1241);const p=(0,u.A)(d,[["render",n]]);var v=p,m=a(1387),y=a(4232);const g={id:"app",class:"d-flex flex-column vh-100"},h={class:"d-flex flex-column overflow-hidden"},f={key:0,class:"h-100"},b={key:1,class:"h-100 d-flex flex-column overflow-hidden"},L={class:"d-none d-xl-flex flex-row overflow-hidden h-100"},w={class:"d-flex d-xl-none flex-column overflow-hidden h-100"},k={class:"d-none d-xl-flex justify-content-between my-app-footer my-title-sm-white my-bgcolor-gray-800 p-2",ref:"appFooterRef"};function x(e,t,a,r,o,l){const s=(0,i.g2)("LoadingOverlay"),n=(0,i.g2)("router-view"),c=(0,i.g2)("LeftView"),d=(0,i.g2)("MiddleView"),u=(0,i.g2)("RightView"),p=(0,i.g2)("UpperView"),v=(0,i.g2)("ResponsiveLowerView");return(0,i.uX)(),(0,i.CE)("div",g,[(0,i.bF)(s,{isVisible:r.isAnyLayerLoading,loadingText:r.loadingText,progress:r.loadingProgress,showProgress:r.showLoadingProgress,subText:r.loadingSubText},null,8,["isVisible","loadingText","progress","showProgress","subText"]),(0,i.Lk)("div",h,["/"!==e.$route.path?((0,i.uX)(),(0,i.CE)("div",f,[(0,i.bF)(n)])):(0,i.Q3)("",!0),"/"===e.$route.path?((0,i.uX)(),(0,i.CE)("div",b,[(0,i.Lk)("div",L,[r.leftViewWidth>0?((0,i.uX)(),(0,i.CE)("div",{key:0,class:"h-100 overflow-y-auto overflow-x-hidden my-left-panel",style:(0,y.Tr)({width:r.leftViewWidthPx})},[(0,i.bF)(c,{selectedServicePoint:r.selectedServicePoint,onClearServicePointDetail:r.handleClearServicePointDetail},null,8,["selectedServicePoint","onClearServicePointDetail"])],4)):(0,i.Q3)("",!0),(0,i.Lk)("div",{class:(0,y.C4)(["my-resizer my-resizer-vertical my-resizer-left",{"my-dragging":r.isSidePanelDragging}]),onMousedown:t[0]||(t[0]=e=>r.startResize("left",e)),title:"拖曳調整左側面板寬度"},null,34),(0,i.bF)(d,{ref:"middlePanelRef",class:"d-flex flex-column overflow-hidden h-100 my-middle-panel",style:(0,y.Tr)([{"z-index":"1"},{width:r.mainPanelWidthPx,"min-width":"0px"}]),dynamicMainAreaHeight:r.calculatedMiddleViewHeight,activeUpperTab:r.activeUpperTab,activeBottomTab:r.activeBottomTab,mainPanelWidth:r.mainPanelWidth,showTainanLayer:r.showTainanLayer,selectedFilter:r.selectedFilter,zoomLevel:r.zoomLevel,currentCoords:r.currentCoords,activeMarkers:r.activeMarkers,isLoadingData:r.isAnyLayerLoading,isSidePanelDragging:r.isSidePanelDragging,"onUpdate:activeUpperTab":t[1]||(t[1]=e=>r.activeUpperTab=e),"onUpdate:activeBottomTab":t[2]||(t[2]=e=>r.activeBottomTab=e),"onUpdate:zoomLevel":t[3]||(t[3]=e=>r.zoomLevel=e),"onUpdate:currentCoords":t[4]||(t[4]=e=>r.currentCoords=e),"onUpdate:activeMarkers":t[5]||(t[5]=e=>r.activeMarkers=e),onResetView:r.resetView,onHighlightOnMap:r.handleHighlight,onHighlightFeature:r.handleHighlight,onShowServicePointDetail:r.handleShowServicePointDetail},null,8,["style","dynamicMainAreaHeight","activeUpperTab","activeBottomTab","mainPanelWidth","showTainanLayer","selectedFilter","zoomLevel","currentCoords","activeMarkers","isLoadingData","isSidePanelDragging","onResetView","onHighlightOnMap","onHighlightFeature","onShowServicePointDetail"]),(0,i.Lk)("div",{class:(0,y.C4)(["my-resizer my-resizer-vertical my-resizer-right",{"my-dragging":r.isSidePanelDragging}]),onMousedown:t[6]||(t[6]=e=>r.startResize("right",e)),title:"拖曳調整右側面板寬度"},null,34),r.rightViewWidth>0?((0,i.uX)(),(0,i.CE)("div",{key:1,class:"h-100 overflow-auto",style:(0,y.Tr)({width:r.rightViewWidthPx})},[(0,i.bF)(u,{activeRightTab:r.activeRightTab,activeMarkers:r.activeMarkers,rightViewWidth:r.rightViewWidth,"onUpdate:activeRightTab":t[7]||(t[7]=e=>r.activeRightTab=e),onHighlightFeature:r.handleHighlight,onShowServicePointDetail:r.handleShowServicePointDetail,"current-coords":r.currentCoords},null,8,["activeRightTab","activeMarkers","rightViewWidth","onHighlightFeature","onShowServicePointDetail","current-coords"])],4)):(0,i.Q3)("",!0)]),(0,i.Lk)("div",w,[r.mobileBottomViewHeight<100?((0,i.uX)(),(0,i.CE)("div",{key:0,class:"flex-shrink-0 overflow-hidden d-flex flex-column",style:(0,y.Tr)({height:100-r.mobileBottomViewHeight+"vh"})},[((0,i.uX)(),(0,i.Wv)(p,{ref:"mobileUpperViewRef",key:r.mobileMapKey,activeUpperTab:r.activeUpperTab,mainPanelWidth:100,contentHeight:(100-r.mobileBottomViewHeight)*e.windowHeight*.01,showTainanLayer:r.showTainanLayer,selectedFilter:r.selectedFilter,zoomLevel:r.zoomLevel,isPanelDragging:r.isVerticalDragging,activeMarkers:r.activeMarkers,"onUpdate:activeUpperTab":t[8]||(t[8]=e=>r.activeUpperTab=e),"onUpdate:zoomLevel":t[9]||(t[9]=e=>r.zoomLevel=e),"onUpdate:currentCoords":t[10]||(t[10]=e=>r.currentCoords=e),"onUpdate:activeMarkers":t[11]||(t[11]=e=>r.activeMarkers=e),onShowServicePointDetail:r.handleShowServicePointDetail},null,8,["activeUpperTab","contentHeight","showTainanLayer","selectedFilter","zoomLevel","isPanelDragging","activeMarkers","onShowServicePointDetail"]))],4)):(0,i.Q3)("",!0),r.mobileBottomViewHeight>0&&r.mobileBottomViewHeight<100?((0,i.uX)(),(0,i.CE)("div",{key:1,class:(0,y.C4)(["my-resizer my-resizer-horizontal my-resizer-middle",{"my-dragging":r.isVerticalDragging}]),onMousedown:t[12]||(t[12]=(...e)=>r.startVerticalResize&&r.startVerticalResize(...e)),onTouchstart:t[13]||(t[13]=(...e)=>r.startVerticalResize&&r.startVerticalResize(...e)),title:"拖曳調整底部面板高度"},null,34)):(0,i.Q3)("",!0),r.mobileBottomViewHeight>0?((0,i.uX)(),(0,i.CE)("div",{key:2,class:"flex-shrink-0 overflow-hidden",style:(0,y.Tr)({height:r.mobileBottomViewHeight+"vh"})},[(0,i.bF)(v,{activeTab:r.activeLowerTab,activeRightTab:r.activeRightTab,activeBottomTab:r.activeBottomTab,"onUpdate:activeTab":t[14]||(t[14]=e=>r.activeLowerTab=e),"onUpdate:activeRightTab":t[15]||(t[15]=e=>r.activeRightTab=e),"onUpdate:activeBottomTab":t[16]||(t[16]=e=>r.activeBottomTab=e),onHighlightOnMap:r.handleHighlight,onHighlightFeature:r.handleHighlight,onShowServicePointDetail:r.handleShowServicePointDetail},null,8,["activeTab","activeRightTab","activeBottomTab","onHighlightOnMap","onHighlightFeature","onShowServicePointDetail"])],4)):(0,i.Q3)("",!0)])])):(0,i.Q3)("",!0)]),(0,i.Lk)("footer",k,t[17]||(t[17]=[(0,i.Lk)("small",null,"臺灣大學地理環境資源學系",-1),(0,i.Lk)("small",null,"2025",-1)]),512)])}a(8111),a(116),a(3579),a(4114),a(2489),a(7588),a(1701),a(8237),a(7642),a(8004),a(3853),a(5876),a(2475),a(5024),a(1698);async function C(e,t=null){try{const a=e.layerId,r=`/long-term-care-web-taichung/data/json/${e.fileName}`,o=await fetch(r);if(!o.ok)throw console.error("HTTP 錯誤:",{status:o.status,statusText:o.statusText,url:o.url}),new Error(`HTTP error! status: ${o.status}`);const i=await o.json();console.log("📅 載入服務紀錄數據，日期篩選:",t);const l=new Map,s={type:"FeatureCollection",features:[]},n=new Map;i.forEach((r=>{if(t){const e=parseInt(t),a=r["服務日期(請輸入7碼)"];if(console.log("🔍 日期篩選檢查:",{filterValue:e,serviceDate:a,serviceDateType:typeof a,matches:a===e}),a!==e)return}else if(1140701!==r["服務日期(請輸入7碼)"])return;const o=r.服務人員身分證,i="category20b-1";if(l.has(o)||l.set(o,{type:"FeatureCollection",features:[]}),r.service_points&&Array.isArray(r.service_points)){if(r.service_points_routes&&Array.isArray(r.service_points_routes)&&r.service_points_routes.forEach((t=>{t.features&&Array.isArray(t.features)&&t.features.forEach((t=>{if(t.geometry&&"LineString"===t.geometry.type){const n={type:"Feature",geometry:t.geometry,properties:{id:`route_${r.服務人員身分證}`,layerId:a,layerName:`${e.layerName}_路線`,name:`服務路線_${r.服務人員身分證}`,strokeColor:i,routeColor:i,strokeWidth:3,strokeOpacity:.8,serviceProviderId:r.服務人員身分證,serviceDate:r["服務日期(請輸入7碼)"],pointCount:t.geometry.coordinates.length,distance:t.properties?.summary?.distance||0,duration:t.properties?.summary?.duration||0,segments:t.properties?.segments?.length||0,...t.properties}};l.get(o).features.push(n),s.features.push(n)}}))})),r.service_points_routes_center&&Array.isArray(r.service_points_routes_center)&&r.service_points_routes_center.length>0){const t=Array.isArray(r.service_points_routes_time)?r.service_points_routes_time:[];r.service_points_routes_center.forEach(((n,c)=>{if(Array.isArray(n)&&n.length>=2){const[d,u]=n;if("number"===typeof d&&"number"===typeof u&&!isNaN(d)&&!isNaN(u)&&u>=-90&&u<=90&&d>=-180&&d<=180){const n=t[c]||null,p=(()=>{if(n&&"number"===typeof n.time_interval)return n.time_interval;const e=n?.hour_interval??null,t=n?.min_interval??null;return"number"===typeof e&&"number"===typeof t?60*e+t:null})(),v=(()=>{if("number"===typeof p&&!isNaN(p)){const e=Math.floor(p/60),t=p%60;return e>0?`${e}h${t}m`:`${t}m`}return"N/A"})(),m={type:"Feature",geometry:{type:"Point",coordinates:[d,u]},properties:{id:`route_center_${r.服務人員身分證}_${c}`,layerId:a,layerName:`${e.layerName}_路線中心點`,name:`路線中心點_${r.服務人員身分證}_${c+1}`,type:"route-center-point",fillColor:i,routeColor:i,serviceProviderId:r.服務人員身分證,serviceDate:r["服務日期(請輸入7碼)"],centerIndex:c+1,"緯度":u,"經度":d,traffic_time_minutes:"number"===typeof p?p:void 0,traffic_time_label:v}};l.get(o).features.push(m),s.features.push(m)}else console.warn(`🚫 無效的路線中心點座標: serviceProvider=${r.服務人員身分證}, index=${c}, coords=[${d}, ${u}]`)}}))}const t=r.service_points.filter((e=>e.detail));if(t.length>0){t.sort(((e,t)=>{const a=e.hour_start+e.min_start/60,r=t.hour_start+t.min_start/60;return a-r})),t.forEach(((t,n)=>{if(t.detail.Lat&&t.detail.Lon){const c=parseFloat(t.detail.Lat),d=parseFloat(t.detail.Lon);if(!isNaN(c)&&!isNaN(d)){const u={type:"Feature",geometry:{type:"Point",coordinates:[d,c]},properties:{id:`point_${r.服務人員身分證}_${n}`,layerId:a,layerName:e.layerName,name:t.detail.姓名,fillColor:i,serviceProviderId:r.服務人員身分證,routeOrder:n+1,serviceTime:`${t.hour_start}:${t.min_start.toString().padStart(2,"0")}`,address:t.detail.個案居住地址,service_items:t.service_items||[],service_items_count:Array.isArray(t.service_items)?t.service_items.length:0,"編號":t.detail.編號,"姓名":t.detail.姓名,"性別":t.detail.性別,"個案戶籍縣市":t.detail.個案戶籍縣市,"鄉鎮區":t.detail.鄉鎮區,"里別":t.detail.里別,"個案戶籍地址":t.detail.個案戶籍地址,"個案居住縣市":t.detail.個案居住縣市,hour_start:t.hour_start,min_start:t.min_start,hour_end:t.hour_end,min_end:t.min_end,time_total:t.time_total,hour_traffic:t.hour_traffic||0,min_traffic:t.min_traffic||0,time_traffic:t.time_traffic||60*(t.hour_traffic||0)+(t.min_traffic||0),detail:t.detail,propertyData:t.detail}};l.get(o).features.push(u),s.features.push(u)}}}));const c=t[0],d=t[t.length-1],u=t.find((e=>e.detail.Lat&&e.detail.Lon));n.set(r.服務人員身分證,{"#":n.size+1,color:getComputedStyle(document.documentElement).getPropertyValue(`--my-color-${i}`).trim(),"服務人員身分證":r.服務人員身分證,"服務日期":r["服務日期(請輸入7碼)"],"服務點位數":r.service_points_count||t.length,"開始時間":`${r.hour_start}:${r.min_start.toString().padStart(2,"0")}`,"結束時間":`${r.hour_end}:${r.min_end.toString().padStart(2,"0")}`,"總服務時間":`${r.hour_total}h${r.min_total}m`,"總時間分鐘":r.time_total||0,"交通時間":(()=>{const e=t.reduce(((e,t)=>e+60*(t.hour_traffic||0)+(t.min_traffic||0)),0),a=Math.floor(e/60),r=e%60;return a>0?`${a}h${r}m`:`${r}m`})(),"交通時間分鐘":t.reduce(((e,t)=>e+60*(t.hour_traffic||0)+(t.min_traffic||0)),0),"服務數量":t.reduce(((e,t)=>e+(t.service_items_count||0)),0),"第一個服務點":c.detail.姓名,"最後一個服務點":d.detail.姓名,firstServicePoint:u?{lat:parseFloat(u.detail.Lat),lon:parseFloat(u.detail.Lon),name:u.detail.姓名,address:u.detail.個案居住地址,time:`${u.hour_start}:${u.min_start.toString().padStart(2,"0")}`}:null,allServicePoints:t.map(((e,t)=>({"順序":t+1,"姓名":e.detail.姓名,"地址":e.detail.個案居住地址,"時間":`${e.hour_start}:${e.min_start.toString().padStart(2,"0")}`,"身分證字號":e["身分證字號"],"編號":e.detail.編號,"性別":e.detail.性別,"個案戶籍縣市":e.detail.個案戶籍縣市,"鄉鎮區":e.detail.鄉鎮區,"里別":e.detail.里別,"個案戶籍地址":e.detail.個案戶籍地址,"個案居住縣市":e.detail.個案居住縣市,"緯度":e.detail.Lat?parseFloat(e.detail.Lat):null,"經度":e.detail.Lon?parseFloat(e.detail.Lon):null,hour_start:e.hour_start,min_start:e.min_start,hour_end:e.hour_end,min_end:e.min_end,service_items_count:e.service_items_count||(Array.isArray(e.service_items)?e.service_items.length:0),service_items:e.service_items||[],"總服務時間分鐘":e.time_total||0,"交通時間":(e.hour_traffic||0)>0?`${e.hour_traffic||0}h${e.min_traffic||0}m`:`${e.min_traffic||0}m`,"交通時間分鐘":60*(e.hour_traffic||0)+(e.min_traffic||0),hour_traffic:e.hour_traffic||0,min_traffic:e.min_traffic||0})))})}}}));const c=Array.from(n.values()),d={};let u=0;s.features.filter((e=>"Point"===e.geometry.type)).forEach((e=>{const t=e.properties.serviceProviderId,a=n.get(t);if(a&&a.allServicePoints.length>0){const e=a.allServicePoints[0].鄉鎮區;e&&"string"===typeof e&&""!==e.trim()&&(d[e]=(d[e]||0)+1,u++)}})),0===Object.keys(d).length&&(console.warn("[loadNewStandardCentralServiceData] 沒有找到有效的行政區資料，使用預設統計"),d["未知區域"]=u||1);const p=Object.entries(d).map((([e,t])=>({name:e||"未知區域",count:Math.max(0,t||0)}))).filter((e=>e.count>0)).sort(((e,t)=>t.count-e.count)),v={totalCount:s.features.filter((e=>"Point"===e.geometry.type)).length,routeCount:s.features.filter((e=>"LineString"===e.geometry.type)).length,districtCount:p},m=Array.from(l.entries()).map((([e,t])=>{const a=n.get(e),r=a?a.allServicePoints.map(((r,o)=>{let i=[];if(t&&t.features){const e=t.features.find((e=>e.properties&&(e.properties.編號===r.編號||e.properties.姓名===r.姓名)));e&&e.properties.service_items&&(i=e.properties.service_items)}return{"#":o+1,id:`point_${e}_${o}`,"姓名":r.姓名,"個案居住地址":r.地址,"時間":r.時間,"服務項目代碼":r.服務項目代碼||"N/A","順序":r.順序,"緯度":r.緯度,"經度":r.經度,"編號":r.編號,"性別":r.性別,"個案戶籍縣市":r.個案戶籍縣市,"鄉鎮區":r.鄉鎮區,"里別":r.里別,"個案戶籍地址":r.個案戶籍地址,"個案居住縣市":r.個案居住縣市,hour_start:r.hour_start,min_start:r.min_start,hour_end:r.hour_end,min_end:r.min_end,"交通時間":r.交通時間,"交通時間分鐘":r.交通時間分鐘,hour_traffic:r.hour_traffic,min_traffic:r.min_traffic,detail:{"編號":r.編號,"姓名":r.姓名,"性別":r.性別,"個案戶籍縣市":r.個案戶籍縣市,"鄉鎮區":r.鄉鎮區,"里別":r.里別,"個案戶籍地址":r.個案戶籍地址,"個案居住縣市":r.個案居住縣市,"個案居住地址":r.地址,Lat:r.緯度,Lon:r.經度},service_items:i,service_items_count:Array.isArray(i)?i.length:0,color:a.color}})):[],o=i.find((t=>t.服務人員身分證===e));return{serviceProviderId:e,layerName:e,geoJsonData:t,tableData:r,pointCount:t.features.filter((e=>"Point"===e.geometry.type)).length,routeCount:t.features.filter((e=>"LineString"===e.geometry.type)).length,servicePointsCount:o?.service_points_count||0}}));return{geoJsonData:s,tableData:c,summaryData:v,serviceProviderLayers:m}}catch(a){throw console.error("❌ 數據載入失敗:",a),a}}const _=(0,o.nY)("data",(()=>{const e=Object.freeze(["category20b-1","category20b-2","category20b-3","category20b-4","category20b-5","category20b-6","category20b-7","category20b-8","category20b-9","category20b-10","category20b-11","category20b-12","category20b-13","category20b-14","category20b-15","category20b-16","category20b-17","category20b-18","category20b-19","category20b-20"]),t=Object.freeze([{groupName:"服務人員列表",groupLayers:[],description:"依日期顯示的長照服務記錄",icon:"fas fa-calendar-day"},{groupName:"服務日期列表",groupLayers:[],description:"依服務人員顯示其所有服務日期",icon:"fas fa-user-nurse"}]),a=(0,c.KR)([...t]),r=e=>{if(!e||"string"!==typeof e)return console.warn("🔍 findLayerById: 無效的圖層 ID",e),null;for(const t of a.value){const a=t.groupLayers.find((t=>t.layerId===e));if(a)return a}return null},o=()=>a.value.reduce(((e,t)=>e.concat(t.groupLayers)),[]),l=async e=>{console.log("🔧 DataStore: toggleLayerVisibility 被調用",e);const t=r(e);t?(console.log("🔧 DataStore: 找到圖層",t.layerName,"當前狀態:",t.visible),t.visible=!t.visible,console.log("🔧 DataStore: 新狀態:",t.visible),console.log(`🔄 圖層 "${t.layerName}" 可見性切換為:`,t.visible)):console.error(`Layer with id "${e}" not found.`)},s=()=>{o().forEach((e=>{e.visible&&(e.visible=!1)})),console.log("🗺️ 已將所有圖層設為不可見（清空地圖顯示）")},n=async e=>{console.log("🔧 DataStore: toggleGroupVisibility 被調用",e);const t=a.value.find((t=>t.groupName===e));if(!t)return void console.error(`Group with name "${e}" not found.`);const r=t.groupLayers.some((e=>e.visible)),o=!r;console.log(`🔧 DataStore: 群組 "${e}" 將 ${o?"顯示":"隱藏"} 所有圖層`),t.groupLayers.forEach((e=>{e.visible=o,console.log(`🔄 圖層 "${e.layerName}" 可見性設為:`,o)}))},d=e=>{const t=a.value.find((t=>t.groupName===e));return!!t&&t.groupLayers.some((e=>e.visible))},u=(0,c.KR)(null),p=(0,c.KR)("1140701"),v=(0,c.KR)(!0),m=(0,c.KR)(""),y=(0,c.KR)(!1),g=(0,c.KR)([]),h=(0,c.KR)("date"),f=e=>{h.value=e,console.log("📑 設置左側面板分頁:",e)},b=e=>{u.value=e},L=()=>{u.value=null},w=e=>{p.value=e,v.value=!!e,console.log("📅 設定服務日期篩選:",e)},k=()=>{p.value="",v.value=!1,console.log("📅 清除服務日期篩選")},x=async t=>{try{console.log("📅 dataStore 接收到的日期參數:",t),console.log("📅 將用此日期查詢 JSON 中的服務日期(請輸入7碼)");const r=a.value.find((e=>"服務人員列表"===e.groupName));if(r){r.groupLayers=[];const e={layerId:"loading-indicator-date",layerName:"服務日期",visible:!1,isLoaded:!1,isLoading:!0,isAnalysisLayer:!1,isIsochroneAnalysisLayer:!1,geoJsonData:null,tableData:[],summaryData:{totalCount:0,routeCount:0,districtCount:[]},legendData:null,colorName:"category20b-1",type:"point",shape:"circle"};r.groupLayers.push(e)}const o=await C({layerId:"新基準中央服務紀錄",colorName:"category20b-1",fileName:"新基準中央服務紀錄_all_2.json"},t,null);if(r){if(r.groupLayers=[],o.serviceProviderLayers&&o.serviceProviderLayers.length>0){console.log("📅 找到",o.serviceProviderLayers.length,"個服務人員");const a=o.serviceProviderLayers.map((e=>e.serviceProviderId)).sort();console.log("📅 服務人員ID排序:",a),console.log("🎨 為當天服務人員分配顏色（按順序）"),a.forEach(((a,i)=>{const l=o.serviceProviderLayers.find((e=>e.serviceProviderId===a));if(!l)return;const s=i%e.length,n=e[s];l.geoJsonData&&l.geoJsonData.features&&l.geoJsonData.features.forEach((e=>{e.properties&&("Point"===e.geometry.type?e.properties.fillColor=n:"LineString"===e.geometry.type&&(e.properties.routeColor=n))}));const c=`service-provider-${l.serviceProviderId}`,d={layerId:c,layerName:l.serviceProviderId,visible:!1,isLoaded:!0,isLoading:!1,isAnalysisLayer:!1,isIsochroneAnalysisLayer:!1,geoJsonData:l.geoJsonData,tableData:l.tableData||[],summaryData:{totalCount:l.servicePointsCount||l.pointCount,routeCount:l.routeCount,districtCount:[]},legendData:null,loader:C,serviceProviderId:l.serviceProviderId,serviceDate:t,colorName:n,type:"point",shape:"circle"};r.groupLayers.push(d),console.log(`📅 創建服務人員圖層: ${l.serviceProviderId} (索引: ${i}, 顏色: ${n}, 已更新GeoJSON顏色)`)}))}else console.log("📅 沒有找到該日期的服務人員數據");console.log("📅 服務人員圖層載入完成，共",r.groupLayers.length,"個圖層")}}catch(r){console.error("📅 載入服務人員圖層失敗:",r)}},_=()=>{const e=a.value.find((e=>"服務人員列表"===e.groupName));e&&(e.groupLayers=[],console.log("📅 已清除所有服務人員圖層"))},S=async()=>{try{const e="/long-term-care-web-taichung/data/json/新基準中央服務紀錄_all_2.json",t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const a=await t.json(),r=[...new Set(a.map((e=>e.服務人員身分證)))],o=r.map((e=>{const t=a.filter((t=>t.服務人員身分證===e)),r=[...new Set(t.map((e=>e["服務日期(請輸入7碼)"])))];return{id:e,name:`${e}`,dateCount:r.length,totalRecords:t.length}}));return o.sort(((e,t)=>t.dateCount-e.dateCount)),g.value=o,console.log("👤 載入服務人員清單，共",o.length,"位服務人員"),o}catch(e){return console.error("👤 載入服務人員清單失敗:",e),[]}},T=e=>{m.value=e,y.value=!!e,console.log("👤 設定服務人員篩選:",e)},P=()=>{m.value="",y.value=!1,console.log("👤 清除服務人員篩選")},I=async t=>{try{console.log("👤 dataStore 接收到的服務人員ID:",t);const r=a.value.find((e=>"服務日期列表"===e.groupName));if(r){r.groupLayers=[];const e={layerId:"loading-indicator-provider",layerName:"服務人員",visible:!1,isLoaded:!1,isLoading:!0,isAnalysisLayer:!1,isIsochroneAnalysisLayer:!1,geoJsonData:null,tableData:[],summaryData:{totalCount:0,routeCount:0,districtCount:[]},legendData:null,colorName:"category20b-1",type:"point",shape:"circle"};r.groupLayers.push(e)}const o="/long-term-care-web-taichung/data/json/新基準中央服務紀錄_all_2.json",i=await fetch(o);if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const l=await i.json(),s=l.filter((e=>e.服務人員身分證===t)),n={};if(s.forEach((e=>{const t=e["服務日期(請輸入7碼)"];n[t]||(n[t]=[]),n[t].push(e)})),r){r.groupLayers=[];const a=Object.keys(n).sort();a.forEach(((a,o)=>{const i=o%e.length,l=e[i],s=n[a],c=D(s,l);if(c&&c.features.length>0){const e=`service-date-${a}`,o=c.features.filter((e=>"Point"===e.geometry.type)).map((e=>({id:e.properties.id,"姓名":e.properties.姓名,"個案居住地址":e.properties.個案居住地址,"起始時間":e.properties.起始時間,"編號":e.properties.編號,"性別":e.properties.性別,detail:e.properties.detail,hour_start:e.properties.hour_start,min_start:e.properties.min_start,hour_end:e.properties.hour_end,min_end:e.properties.min_end,hour_traffic:e.properties.hour_traffic,min_traffic:e.properties.min_traffic,service_items:e.properties.service_items,service_items_count:e.properties.service_items_count||(Array.isArray(e.properties.service_items)?e.properties.service_items.length:0),serviceProviderId:e.properties.serviceProviderId,serviceDate:e.properties.serviceDate,routeOrder:e.properties.routeOrder,lat:e.geometry.coordinates[1],lon:e.geometry.coordinates[0]}))),i=s.reduce(((e,t)=>e+(t.service_points_count||0)),0),n={layerId:e,layerName:`${a}`,visible:!1,isLoaded:!0,isLoading:!1,colorName:l,type:"point",geoJsonData:c,tableData:o,summaryData:{totalCount:i||c.features.filter((e=>"Point"===e.geometry.type)).length,pointCount:c.features.filter((e=>"Point"===e.geometry.type)).length,lineCount:c.features.filter((e=>"LineString"===e.geometry.type)).length},serviceProviderId:t,serviceDate:a};r.groupLayers.push(n)}})),console.log("👤 載入完成，共",a.length,"個日期的圖層")}}catch(r){console.error("👤 載入服務人員日期圖層失敗:",r)}},M=()=>{const e=a.value.find((e=>"服務日期列表"===e.groupName));e&&(e.groupLayers=[],console.log("👤 已清除服務人員群組的所有圖層"))},D=(e,t)=>{const a=[];return e.forEach(((e,r)=>{if(e.service_points_routes&&Array.isArray(e.service_points_routes)&&e.service_points_routes.forEach((o=>{o.features&&Array.isArray(o.features)&&o.features.forEach((o=>{o.geometry&&"LineString"===o.geometry.type&&a.push({type:"Feature",geometry:o.geometry,properties:{id:`route_${e.服務人員身分證}_${r}`,layerName:"服務路線_路線",name:`服務路線_${e.服務人員身分證}`,strokeColor:t,routeColor:t,strokeWidth:3,strokeOpacity:.8,serviceProviderId:e.服務人員身分證,serviceDate:e["服務日期(請輸入7碼)"],pointCount:o.geometry.coordinates.length,distance:o.properties?.summary?.distance||0,duration:o.properties?.summary?.duration||0,segments:o.properties?.segments?.length||0,...o.properties}})}))})),e.route&&e.route.length>1){const o=e.route.map((e=>[e.lon,e.lat]));a.push({type:"Feature",geometry:{type:"LineString",coordinates:o},properties:{id:`route_${e.服務人員身分證}_${r}`,layerName:"服務路線_路線",routeColor:t,serviceProviderId:e.服務人員身分證,serviceDate:e["服務日期(請輸入7碼)"]}})}e.service_points.forEach(((r,o)=>{if(r.detail&&r.detail.Lat&&r.detail.Lon){const i=parseFloat(r.detail.Lat),l=parseFloat(r.detail.Lon);isNaN(i)||isNaN(l)||a.push({type:"Feature",geometry:{type:"Point",coordinates:[l,i]},properties:{id:`point_${e.服務人員身分證}_${o}`,fillColor:t,routeOrder:o+1,serviceProviderId:e.服務人員身分證,serviceDate:e["服務日期(請輸入7碼)"],"姓名":r.detail.姓名,"身分證字號":r["身分證字號"],"個案居住地址":r.detail.個案居住地址,"起始時間":`${r.hour_start}:${r.min_start.toString().padStart(2,"0")}`,"編號":r.detail.編號,"性別":r.detail.性別,detail:r.detail,hour_start:r.hour_start,min_start:r.min_start,hour_end:r.hour_end,min_end:r.min_end,hour_traffic:r.hour_traffic||0,min_traffic:r.min_traffic||0,service_items:r.service_items||[]}})}}))})),{type:"FeatureCollection",features:a}},E=e=>{if(!v.value||!p.value)return!0;if(e&&e["服務日期(請輸入7碼)"]){const t=e["服務日期(請輸入7碼)"].toString();return t===p.value}return!0},$=(e,t,a,r)=>{const o=6371e3,i=(a-e)*Math.PI/180,l=(r-t)*Math.PI/180,s=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(l/2)*Math.sin(l/2),n=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));return o*n},F=(e,t,a=2e3)=>{const r=[],i=o().filter((e=>e.visible&&e.isLoaded&&"point"===e.type&&!e.isAnalysisLayer&&!e.isIsochroneAnalysisLayer&&e.geoJsonData));return console.log("🔍 檢查可見的點圖層:",i.map((e=>e.layerName))),i.forEach((o=>{o.geoJsonData&&o.geoJsonData.features&&o.geoJsonData.features.forEach((i=>{if("Point"===i.geometry.type){const[l,s]=i.geometry.coordinates,n=$(e,t,s,l);if(n<=a){const e={...i,layerId:o.layerId,layerName:o.layerName,distance:Math.round(n)};r.push(e)}}}))})),r.sort(((e,t)=>e.distance-t.distance)),console.log(`🎯 在 ${a/1e3}公里範圍內找到 ${r.length} 個點物件`),r},z=(e,t,a=2e3)=>{const r=[],i=o().filter((e=>e.visible&&e.isLoaded&&"polygon"===e.type&&!e.isAnalysisLayer&&!e.isIsochroneAnalysisLayer&&e.geoJsonData));return console.log("🔍 檢查可見的多邊形圖層:",i.map((e=>e.layerName))),i.forEach((o=>{o.geoJsonData&&o.geoJsonData.features&&o.geoJsonData.features.forEach((i=>{if("Polygon"===i.geometry.type||"MultiPolygon"===i.geometry.type){const l=N(i.geometry,e,t,a);if(l){const e={...i,layerId:o.layerId,layerName:o.layerName,overlapType:"intersects"};r.push(e)}}}))})),console.log(`🎯 在 ${a/1e3}公里範圍內找到 ${r.length} 個重疊多邊形`),r},N=(e,t,a,r)=>{const o="Polygon"===e.type?[e.coordinates]:e.coordinates;for(const i of o)for(const e of i)for(const[o,i]of e){const e=$(t,a,i,o);if(e<=r)return!0}return!1};return{layers:a,findLayerById:r,getAllLayers:o,toggleLayerVisibility:l,toggleGroupVisibility:n,isGroupVisible:d,selectedFeature:u,setSelectedFeature:b,clearSelectedFeature:L,selectedServiceDate:p,isDateFilterActive:v,setServiceDateFilter:w,clearServiceDateFilter:k,matchesDateFilter:E,loadServiceProviderLayers:x,clearServiceProviderLayers:_,selectedServiceProvider:m,isServiceProviderFilterActive:y,availableServiceProviders:g,loadAvailableServiceProviders:S,setServiceProviderFilter:T,clearServiceProviderFilter:P,loadServiceProviderDateLayers:I,clearServiceProviderDateLayers:M,hideAllLayersOnMap:s,activeLeftTab:h,setActiveLeftTab:f,calculatePointsInRange:F,calculatePolygonInRange:z,visibleLayers:(0,i.EW)((()=>o().filter((e=>e.visible)))),loadingLayers:(0,i.EW)((()=>o().filter((e=>e.isLoading)))),createServiceItemsData:(e,t)=>{console.log(">> [1] createServiceItemsData: 開始處理",{itemOrFeature:e,layerName:t.layerName});const a="Feature"===e.type,r=a?e.properties:e,o=r.service_items&&Array.isArray(r.service_items)?[...r.service_items]:[];0===o.length?console.warn("!! [1a] createServiceItemsData: `properties` 中缺少 `service_items` 或其為空!",r):console.log(">> [1b] createServiceItemsData: 成功找到 service_items，數量:",o.length);const i={type:"service-items",layerId:t.layerId,layerName:t.layerName,servicePoint:r,serviceItems:o,servicePointInfo:{name:r.姓名||r.name,address:r.個案居住地址||r.address,time:r.時間||r.time,serviceType:r.服務項目代碼||r.serviceType,order:r.順序||r.order,lat:r.緯度||r.lat,lng:r.經度||r.lon}};return console.log(">> [2] createServiceItemsData: 處理完成，返回 serviceItemsData",i),{serviceItemsData:i}}}}),{persist:!0}),S=["aria-label"],T={class:"loading-overlay__content"},P={class:"loading-overlay__spinner-container"},I={class:"visually-hidden"},M={class:"loading-overlay__text-container"},D={class:"loading-overlay__title my-title-lg-black",id:"loading-title"},E={key:0,class:"loading-overlay__subtitle my-content-xs-gray mt-2 mb-0",id:"loading-subtitle"},$={key:0,class:"loading-overlay__progress-container mt-3"},F={class:"loading-overlay__progress-label d-flex justify-content-between align-items-center mb-2"},z={class:"my-content-xs-gray fw-bold"},N=["aria-valuenow","aria-label"],V={class:"visually-hidden"};function A(e,t,a,o,l,s){return(0,i.uX)(),(0,i.Wv)(r.eB,{name:"loading-overlay","enter-active-class":"loading-overlay-enter-active","leave-active-class":"loading-overlay-leave-active","enter-from-class":"loading-overlay-enter-from","leave-to-class":"loading-overlay-leave-to"},{default:(0,i.k6)((()=>[a.isVisible?((0,i.uX)(),(0,i.CE)("div",{key:0,class:"loading-overlay",role:"dialog","aria-modal":"true","aria-label":o.getLoadingDescription(),"aria-live":"polite"},[(0,i.Lk)("div",{class:"loading-overlay__backdrop",onClick:t[0]||(t[0]=(0,r.D$)((()=>{}),["stop"]))}),(0,i.Lk)("div",T,[(0,i.Lk)("div",P,[(0,i.Lk)("div",{class:(0,y.C4)(["spinner-border mb-3",o.themeClass]),style:(0,y.Tr)(o.spinnerStyle),role:"status","aria-hidden":"true"},[(0,i.Lk)("span",I,(0,y.v_)(a.loadingText),1)],6)]),(0,i.Lk)("div",M,[(0,i.Lk)("div",D,(0,y.v_)(a.loadingText),1),a.subText?((0,i.uX)(),(0,i.CE)("p",E,(0,y.v_)(a.subText),1)):(0,i.Q3)("",!0)]),o.shouldShowProgress?((0,i.uX)(),(0,i.CE)("div",$,[(0,i.Lk)("div",F,[t[1]||(t[1]=(0,i.Lk)("small",{class:"my-content-xs-gray"},"載入進度",-1)),(0,i.Lk)("small",z,(0,y.v_)(o.formattedProgress)+"%",1)]),(0,i.Lk)("div",{class:"progress loading-overlay__progress-bar",role:"progressbar","aria-valuenow":o.formattedProgress,"aria-label":o.getProgressAriaLabel(),"aria-valuemin":"0","aria-valuemax":"100"},[(0,i.Lk)("div",{class:(0,y.C4)(["progress-bar",o.progressBarClass]),style:(0,y.Tr)({width:o.formattedProgress+"%"})},[(0,i.Lk)("span",V,(0,y.v_)(o.formattedProgress)+"% 完成",1)],6)],8,N)])):(0,i.Q3)("",!0)])],8,S)):(0,i.Q3)("",!0)])),_:1})}var R={name:"LoadingOverlay",props:{isVisible:{type:Boolean,default:!1,required:!0,validator:e=>"boolean"===typeof e},loadingText:{type:String,default:"載入中...",validator:e=>"string"===typeof e&&e.length>0},progress:{type:Number,default:-1,validator:e=>"number"===typeof e&&!isNaN(e)&&e>=-1&&e<=100},showProgress:{type:Boolean,default:!1},subText:{type:String,default:""},theme:{type:String,default:"primary",validator:e=>["primary","secondary","success","warning","danger"].includes(e)},size:{type:String,default:"md",validator:e=>["sm","md","lg"].includes(e)}},setup(e){const t={sm:{width:"1.5rem",height:"1.5rem"},md:{width:"2rem",height:"2rem"},lg:{width:"2.5rem",height:"2.5rem"}},a=(0,i.EW)((()=>({...t[e.size]}))),r=(0,i.EW)((()=>`text-${e.theme}`)),o=(0,i.EW)((()=>`bg-${e.theme}`)),l=(0,i.EW)((()=>e.progress<0?0:Math.max(0,Math.min(100,Math.round(e.progress))))),s=(0,i.EW)((()=>e.showProgress&&e.progress>=0)),n=()=>`載入進度 ${l.value} 百分比`,c=()=>{let t=e.loadingText;return e.subText&&(t+=`，${e.subText}`),s.value&&(t+=`，進度 ${l.value}%`),t};return{spinnerStyle:a,themeClass:r,progressBarClass:o,formattedProgress:l,shouldShowProgress:s,getProgressAriaLabel:n,getLoadingDescription:c}}};const W=(0,u.A)(R,[["render",A],["__scopeId","data-v-430a6fa8"]]);var X=W;const B={class:"my-bgcolor-gray-100 h-100 d-flex flex-column overflow-hidden"},K={class:"p-3"},O={class:"d-flex justify-content-center pt-3"},H={class:"d-flex align-items-center rounded-pill shadow my-blur gap-1 p-2"},U={class:"flex-grow-1 overflow-hidden"},j={class:"h-100"},J={class:"h-100"},Q={key:0,class:"mt-3 p-3 my-bgcolor-white rounded shadow-sm"},G={class:"row g-2"},Y={class:"col-12"},q={class:"my-content-sm-black"},Z={class:"col-12"},ee={class:"my-content-sm-black"},te={class:"col-6"},ae={class:"my-content-sm-black"},re={class:"col-6"},oe={class:"my-content-sm-black"},ie={class:"col-6"},le={class:"my-content-sm-black"},se={class:"col-6"},ne={class:"my-content-sm-black"},ce={class:"col-12"},de={class:"my-content-sm-black"},ue={class:"mt-3 pt-2 border-top"};function pe(e,t,a,o,l,s){const n=(0,i.g2)("DateLayersTab"),c=(0,i.g2)("ServerLayersTab");return(0,i.uX)(),(0,i.CE)("div",B,[(0,i.Lk)("div",K,[t[5]||(t[5]=(0,i.Lk)("h1",{class:"my-font-size-lg my-letter-spacing-lg text-center m-3"},"臺中市長照服務路線",-1)),(0,i.Lk)("div",O,[(0,i.Lk)("div",H,[(0,i.Lk)("button",{class:(0,y.C4)(["btn rounded-pill border-0 d-flex align-items-center justify-content-center my-btn-transparent my-font-size-xs",{"my-btn-blue":"date"===o.activeLeftTab}]),onClick:t[0]||(t[0]=e=>o.switchLeftTab("date")),style:{height:"30px"},title:"日期圖層"},t[3]||(t[3]=[(0,i.Lk)("i",{class:"fas fa-calendar-day"},null,-1),(0,i.Lk)("span",{class:"ps-2"},"服務日期",-1)]),2),(0,i.Lk)("button",{class:(0,y.C4)(["btn rounded-pill border-0 d-flex align-items-center justify-content-center my-btn-transparent my-font-size-xs",{"my-btn-blue":"server"===o.activeLeftTab}]),onClick:t[1]||(t[1]=e=>o.switchLeftTab("server")),style:{height:"30px"},title:"伺服器圖層"},t[4]||(t[4]=[(0,i.Lk)("i",{class:"fa-solid fa-user-nurse"},null,-1),(0,i.Lk)("span",{class:"ps-2"},"服務人員",-1)]),2)])])]),(0,i.Lk)("div",U,[(0,i.bo)((0,i.Lk)("div",j,[(0,i.bF)(n)],512),[[r.aG,"date"===o.activeLeftTab]]),(0,i.bo)((0,i.Lk)("div",J,[(0,i.bF)(c)],512),[[r.aG,"server"===o.activeLeftTab]]),a.selectedServicePoint?((0,i.uX)(),(0,i.CE)("div",Q,[t[14]||(t[14]=(0,i.Lk)("h6",{class:"my-title-sm-black mb-3"},[(0,i.Lk)("i",{class:"fas fa-info-circle me-2"}),(0,i.eW)(" 服務點詳細資訊 ")],-1)),(0,i.Lk)("div",G,[(0,i.Lk)("div",Y,[t[6]||(t[6]=(0,i.Lk)("div",{class:"my-content-xs-gray mb-1"},"姓名",-1)),(0,i.Lk)("div",q,(0,y.v_)(a.selectedServicePoint.servicePointInfo?.name||"無資料"),1)]),(0,i.Lk)("div",Z,[t[7]||(t[7]=(0,i.Lk)("div",{class:"my-content-xs-gray mb-1"},"服務地址",-1)),(0,i.Lk)("div",ee,(0,y.v_)(a.selectedServicePoint.servicePointInfo?.address||"無資料"),1)]),(0,i.Lk)("div",te,[t[8]||(t[8]=(0,i.Lk)("div",{class:"my-content-xs-gray mb-1"},"服務時間",-1)),(0,i.Lk)("div",ae,(0,y.v_)(a.selectedServicePoint.servicePointInfo?.time||"無資料"),1)]),(0,i.Lk)("div",re,[t[9]||(t[9]=(0,i.Lk)("div",{class:"my-content-xs-gray mb-1"},"服務項目代碼",-1)),(0,i.Lk)("div",oe,(0,y.v_)(a.selectedServicePoint.servicePointInfo?.serviceType||"無資料"),1)]),(0,i.Lk)("div",ie,[t[10]||(t[10]=(0,i.Lk)("div",{class:"my-content-xs-gray mb-1"},"順序",-1)),(0,i.Lk)("div",le,(0,y.v_)(a.selectedServicePoint.servicePointInfo?.order||"無資料"),1)]),(0,i.Lk)("div",se,[t[11]||(t[11]=(0,i.Lk)("div",{class:"my-content-xs-gray mb-1"},"服務日期",-1)),(0,i.Lk)("div",ne,(0,y.v_)(a.selectedServicePoint.servicePointInfo?.serviceDate||"無資料"),1)]),(0,i.Lk)("div",ce,[t[12]||(t[12]=(0,i.Lk)("div",{class:"my-content-xs-gray mb-1"},"座標",-1)),(0,i.Lk)("div",de,(0,y.v_)(a.selectedServicePoint.servicePointInfo?.lat&&a.selectedServicePoint.servicePointInfo?.lng?`${a.selectedServicePoint.servicePointInfo.lat.toFixed(6)}, ${a.selectedServicePoint.servicePointInfo.lng.toFixed(6)}`:"無資料"),1)])]),(0,i.Lk)("div",ue,[(0,i.Lk)("button",{class:"btn btn-sm my-btn-outline-primary w-100",onClick:t[2]||(t[2]=(...e)=>o.clearServicePointDetail&&o.clearServicePointDetail(...e))},t[13]||(t[13]=[(0,i.Lk)("i",{class:"fas fa-times me-2"},null,-1),(0,i.eW)(" 清除資訊 ")]))])])):(0,i.Q3)("",!0)])])}const ve={class:"h-100 d-flex flex-column overflow-hidden my-bgcolor-gray-100"},me={class:"flex-grow-1 overflow-auto layer-list-container",ref:"layerListRef"},ye={class:"mb-3"},ge={class:"p-3"},he={class:"mb-2"},fe={class:"d-flex align-items-center pb-2"},be={class:"my-title-xs-gray"},Le={key:0},we={key:0,class:"d-flex align-items-center justify-content-center ms-auto"},ke=["id","checked","onChange"],xe=["for"],Ce=["onClick"],_e={class:"w-100"},Se={class:"d-flex"},Te={class:"d-flex align-items-center text-start w-100 px-3 py-2"},Pe={class:"my-content-sm-black"},Ie={class:"my-content-xs-gray ms-2"},Me={class:"d-flex align-items-center justify-content-center px-3 py-2"},De=["id","checked","disabled","onChange"],Ee=["for"],$e={key:0,class:"px-3 pb-2"},Fe={class:"my-content-xs-black text-nowrap ms-2"};function ze(e,t,a,r,o,l){const s=(0,i.g2)("DatePicker");return(0,i.uX)(),(0,i.CE)("div",ve,[(0,i.Lk)("div",me,[(0,i.Lk)("div",ye,[(0,i.Lk)("div",ge,[(0,i.Lk)("div",he,[t[1]||(t[1]=(0,i.Lk)("div",{class:"my-title-xs-gray mb-1"},"選擇服務日期",-1)),(0,i.bF)(s,{modelValue:r.selectedServiceDate,"onUpdate:modelValue":t[0]||(t[0]=e=>r.selectedServiceDate=e),placeholder:"選擇服務日期",onDateSelected:r.handleDateSelected},null,8,["modelValue","onDateSelected"])])]),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(r.layers.filter((e=>"服務人員列表"===e.groupName)),(e=>((0,i.uX)(),(0,i.CE)("div",{key:e.groupName,class:"p-3"},[(0,i.Lk)("div",fe,[(0,i.Lk)("div",be,[(0,i.eW)((0,y.v_)(e.groupName)+" ",1),e.groupLayers.length>0?((0,i.uX)(),(0,i.CE)("span",Le," ("+(0,y.v_)(e.groupLayers.length)+") ",1)):(0,i.Q3)("",!0)]),e.groupLayers.length>0?((0,i.uX)(),(0,i.CE)("div",we,[(0,i.Lk)("input",{type:"checkbox",id:"group-switch-"+e.groupName,checked:r.isGroupVisible(e.groupName),onChange:t=>r.toggleGroup(e.groupName)},null,40,ke),(0,i.Lk)("label",{for:"group-switch-"+e.groupName,style:{"--layer-color":"var(--my-color-green)"}},null,8,xe)])):(0,i.Q3)("",!0)]),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(e.groupLayers,(e=>((0,i.uX)(),(0,i.CE)("div",{key:e.layerId,class:"mb-1"},[(0,i.Lk)("div",{class:"btn rounded-0 border-0 d-flex shadow-sm my-bgcolor-white-hover p-0",onClick:t=>r.toggleLayer(e.layerId)},[(0,i.Lk)("div",{class:"d-flex",style:(0,y.Tr)({backgroundColor:r.getLayerColor(e),minWidth:"6px"})},null,4),(0,i.Lk)("div",_e,[(0,i.Lk)("div",Se,[(0,i.Lk)("div",Te,[(0,i.Lk)("span",Pe,[(0,i.eW)((0,y.v_)(e.layerName)+" ",1),(0,i.Lk)("span",Ie,(0,y.v_)(e.summaryData?.totalCount),1)])]),(0,i.Lk)("div",Me,[(0,i.Lk)("input",{type:"checkbox",id:"switch-"+e.layerId,checked:e.visible,disabled:e.isLoading,onChange:t=>r.toggleLayer(e.layerId)},null,40,De),(0,i.Lk)("label",{for:"switch-"+e.layerId,style:{"--layer-color":"var(--my-color-green)"}},null,8,Ee)])]),e.legendData&&e.visible?((0,i.uX)(),(0,i.CE)("div",$e,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(e.legendData,(e=>((0,i.uX)(),(0,i.CE)("div",{key:e.color,class:"d-flex align-items-center"},[(0,i.Lk)("div",{style:(0,y.Tr)([{"min-width":"6px","min-height":"18px"},{backgroundColor:e.color}])},null,4),(0,i.Lk)("div",Fe,(0,y.v_)(e.label),1)])))),128))])):(0,i.Q3)("",!0)])],8,Ce)])))),128))])))),128))])],512)])}const Ne=Object.freeze({add:{zh:"新增",en:"Add",icon:"fas fa-plus",category:"action",description:"新增項目或資料"},edit:{zh:"編輯",en:"Edit",icon:"fas fa-edit",category:"action",description:"編輯現有項目"},delete:{zh:"刪除",en:"Delete",icon:"fas fa-trash",category:"action",description:"刪除項目"},save:{zh:"儲存",en:"Save",icon:"fas fa-save",category:"action",description:"儲存變更"},cancel:{zh:"取消",en:"Cancel",icon:"fas fa-times",category:"action",description:"取消操作"},confirm:{zh:"確認",en:"Confirm",icon:"fas fa-check",category:"action",description:"確認操作"},search:{zh:"搜尋",en:"Search",icon:"fas fa-search",category:"action",description:"搜尋功能"},filter:{zh:"篩選",en:"Filter",icon:"fas fa-filter",category:"action",description:"資料篩選"},sort:{zh:"排序",en:"Sort",icon:"fas fa-sort",category:"action",description:"資料排序"},refresh:{zh:"重新整理",en:"Refresh",icon:"fas fa-sync-alt",category:"action",description:"重新載入資料"},upload:{zh:"上傳",en:"Upload",icon:"fas fa-upload",category:"file",description:"上傳檔案"},download:{zh:"下載",en:"Download",icon:"fas fa-download",category:"file",description:"下載檔案"},import:{zh:"匯入",en:"Import",icon:"fas fa-file-import",category:"file",description:"匯入資料"},export:{zh:"匯出",en:"Export",icon:"fas fa-file-export",category:"file",description:"匯出資料"},folder:{zh:"資料夾",en:"Folder",icon:"fas fa-folder",category:"file",description:"檔案資料夾"},folder_open:{zh:"開啟資料夾",en:"Open Folder",icon:"fas fa-folder-open",category:"file",description:"開啟的資料夾"},file:{zh:"檔案",en:"File",icon:"fas fa-file",category:"file",description:"一般檔案"},home:{zh:"首頁",en:"Home",icon:"fas fa-home",category:"navigation",description:"返回首頁"},back:{zh:"返回",en:"Back",icon:"fas fa-arrow-left",category:"navigation",description:"返回上一頁"},forward:{zh:"前進",en:"Forward",icon:"fas fa-arrow-right",category:"navigation",description:"前往下一頁"},up:{zh:"向上",en:"Up",icon:"fas fa-arrow-up",category:"navigation",description:"向上移動"},down:{zh:"向下",en:"Down",icon:"fas fa-arrow-down",category:"navigation",description:"向下移動"},success:{zh:"成功",en:"Success",icon:"fas fa-check-circle",category:"status",description:"操作成功"},error:{zh:"錯誤",en:"Error",icon:"fas fa-exclamation-circle",category:"status",description:"發生錯誤"},warning:{zh:"警告",en:"Warning",icon:"fas fa-exclamation-triangle",category:"status",description:"警告訊息"},info:{zh:"資訊",en:"Info",icon:"fas fa-info-circle",category:"status",description:"資訊提示"},loading:{zh:"載入中",en:"Loading",icon:"fas fa-spinner",category:"status",description:"載入狀態"},view:{zh:"檢視",en:"View",icon:"fas fa-eye",category:"view",description:"顯示項目"},hide:{zh:"隱藏",en:"Hide",icon:"fas fa-eye-slash",category:"view",description:"隱藏項目"},expand:{zh:"展開",en:"Expand",icon:"fas fa-expand",category:"view",description:"展開視圖"},collapse:{zh:"收縮",en:"Collapse",icon:"fas fa-compress",category:"view",description:"收縮視圖"},layer:{zh:"圖層",en:"Layer",icon:"fas fa-layer-group",category:"data",description:"地圖圖層"},visible:{zh:"可見",en:"Visible",icon:"fas fa-eye",category:"data",description:"可見狀態"},hidden:{zh:"隱藏",en:"Hidden",icon:"fas fa-eye-slash",category:"data",description:"隱藏狀態"},data:{zh:"資料",en:"Data",icon:"fas fa-database",category:"data",description:"資料庫資料"},table:{zh:"表格",en:"Table",icon:"fas fa-table",category:"data",description:"資料表格"},map:{zh:"地圖",en:"Map",icon:"fas fa-map",category:"map",description:"地圖視圖"},location:{zh:"位置",en:"Location",icon:"fas fa-map-marker-alt",category:"map",description:"地理位置"},zoom_in:{zh:"放大",en:"Zoom In",icon:"fas fa-search-plus",category:"map",description:"放大地圖"},zoom_out:{zh:"縮小",en:"Zoom Out",icon:"fas fa-search-minus",category:"map",description:"縮小地圖"},center:{zh:"居中",en:"Center",icon:"fas fa-crosshairs",category:"map",description:"地圖居中"},chart:{zh:"圖表",en:"Chart",icon:"fas fa-chart-bar",category:"analysis",description:"圖表展示"},statistics:{zh:"統計",en:"Statistics",icon:"fas fa-chart-line",category:"analysis",description:"統計分析"},dashboard:{zh:"儀表板",en:"Dashboard",icon:"fas fa-tachometer-alt",category:"analysis",description:"資料儀表板"},analysis:{zh:"分析",en:"Analysis",icon:"fas fa-analytics",category:"analysis",description:"資料分析"},hospital:{zh:"醫院",en:"Hospital",icon:"fas fa-hospital",category:"medical",description:"醫院機構"},clinic:{zh:"診所",en:"Clinic",icon:"fas fa-clinic-medical",category:"medical",description:"診所機構"},pharmacy:{zh:"藥局",en:"Pharmacy",icon:"fas fa-pills",category:"medical",description:"藥局機構"},elderly_care:{zh:"長照",en:"Elderly Care",icon:"fas fa-hands-helping",category:"medical",description:"長期照護"},medical:{zh:"醫療",en:"Medical",icon:"fas fa-user-md",category:"medical",description:"醫療服務"},population:{zh:"人口",en:"Population",icon:"fas fa-users",category:"social",description:"人口資料"},demographics:{zh:"人口統計",en:"Demographics",icon:"fas fa-user-friends",category:"social",description:"人口統計資料"},community:{zh:"社區",en:"Community",icon:"fas fa-home",category:"social",description:"社區資訊"},income:{zh:"收入",en:"Income",icon:"fas fa-dollar-sign",category:"economic",description:"收入資料"},tax:{zh:"稅收",en:"Tax",icon:"fas fa-file-invoice-dollar",category:"economic",description:"稅收資料"},drag:{zh:"拖拉",en:"Drag",icon:"fa-solid fa-grip-lines-vertical",category:"control",description:"拖拽控制"},move_up:{zh:"上移",en:"Move Up",icon:"fas fa-arrow-up",category:"control",description:"向上移動"},move_down:{zh:"下移",en:"Move Down",icon:"fas fa-arrow-down",category:"control",description:"向下移動"},reset:{zh:"重設",en:"Reset",icon:"fas fa-undo",category:"control",description:"重設設定"},settings:{zh:"設定",en:"Settings",icon:"fas fa-cog",category:"settings",description:"系統設定"},sort_up:{zh:"升序",en:"Sort Ascending",icon:"fas fa-sort-up",category:"settings",description:"升序排列"},sort_down:{zh:"降序",en:"Sort Descending",icon:"fas fa-sort-down",category:"settings",description:"降序排列"},menu:{zh:"選單",en:"Menu",icon:"fas fa-bars",category:"ui",description:"選單按鈕"},close:{zh:"關閉",en:"Close",icon:"fas fa-times",category:"ui",description:"關閉按鈕"}});function Ve(e,t="zh"){const a=Ne[e];return a?{text:a[t]||a.zh,icon:a.icon,category:a.category,description:a.description}:(console.warn(`🎨 找不到圖標定義: ${e}`),{text:e,icon:"fas fa-question-circle",category:"unknown",description:`未定義的圖標: ${e}`})}const Ae={class:"date-picker-container"},Re={class:"calendar-container bg-white border rounded shadow-sm p-2"},We={class:"calendar-header d-flex justify-content-center align-items-center mb-2"},Xe={class:"mb-0 my-font-size-sm"},Be={class:"calendar-weekdays d-flex mb-1"},Ke={class:"calendar-days"},Oe=["onClick"];function He(e,t,a,r,o,l){return(0,i.uX)(),(0,i.CE)("div",Ae,[(0,i.Lk)("div",Re,[(0,i.Lk)("div",We,[(0,i.Lk)("h6",Xe,(0,y.v_)(r.currentYear)+"年"+(0,y.v_)(r.currentMonth)+"月",1)]),(0,i.Lk)("div",Be,[((0,i.uX)(),(0,i.CE)(i.FK,null,(0,i.pI)(["日","一","二","三","四","五","六"],(e=>(0,i.Lk)("div",{key:e,class:"calendar-weekday text-center my-font-size-xs my-title-xs-gray",style:{flex:"1",padding:"4px 2px"}},(0,y.v_)(e),1))),64))]),(0,i.Lk)("div",Ke,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(r.calendarDays,((e,t)=>((0,i.uX)(),(0,i.CE)("div",{key:t,class:(0,y.C4)(["calendar-day text-center my-font-size-xs",{"text-muted":!e.isCurrentMonth,"bg-primary text-white":e.isSelected,"calendar-day-hover":e.isCurrentMonth&&e.day}]),onClick:t=>r.selectDate(e)},(0,y.v_)(e.day),11,Oe)))),128))])])])}var Ue={name:"DatePicker",props:{modelValue:{type:String,default:""},placeholder:{type:String,default:"選擇服務日期"}},emits:["update:modelValue","date-selected"],setup(e,{emit:t}){const a=(0,c.KR)(!1),r=(0,c.KR)(e.modelValue||""),o=(0,c.KR)(2025),l=(0,c.KR)(7),s=(0,i.EW)((()=>{const e=o.value,t=l.value,a=new Date(e,t-1,1).getDay(),i=new Date(e,t,0).getDate(),s=[];for(let r=0;r<a;r++)s.push({day:"",isCurrentMonth:!1});for(let o=1;o<=i;o++){const a=n(e,t,o);s.push({day:o,isCurrentMonth:!0,isSelected:a===r.value,dateStr:a})}return s})),n=(e,t,a)=>{const r=(e-1911).toString().padStart(3,"0"),o=t.toString().padStart(2,"0"),i=a.toString().padStart(2,"0");return`${r}${o}${i}`},d=e=>{if(7===e.length){const t=parseInt(e.substring(0,3)),a=t+1911,r=parseInt(e.substring(3,5)),o=parseInt(e.substring(5,7));return{year:a,month:r,day:o}}return null},u=()=>{if(a.value=!a.value,a.value&&r.value){const e=d(r.value);e&&(o.value=e.year,l.value=e.month)}},p=e=>{if(e.isCurrentMonth&&e.day){const i=n(o.value,l.value,e.day);r.value=i,t("update:modelValue",i),t("date-selected",i),a.value=!1}},v=()=>{},m=()=>{},y=e=>{e.target.closest(".date-picker-container")||(a.value=!1)};return(0,i.wB)((()=>e.modelValue),(e=>{r.value=e||""})),(0,i.sV)((()=>{document.addEventListener("click",y)})),(0,i.hi)((()=>{document.removeEventListener("click",y)})),{isOpen:a,selectedDate:r,currentYear:o,currentMonth:l,calendarDays:s,toggleCalendar:u,selectDate:p,previousMonth:v,nextMonth:m}}};const je=(0,u.A)(Ue,[["render",He],["__scopeId","data-v-3fddd1ae"]]);var Je=je,Qe={name:"DateLayersTab",components:{DatePicker:Je},setup(){const e=_(),t=(0,c.KR)(null),a=(0,i.EW)((()=>e.layers)),r=(0,i.EW)({get:()=>e.selectedServiceDate,set:t=>{t?e.setServiceDateFilter(t):e.clearServiceDateFilter()}}),o=t=>{if(console.log("🔘 DateLayersTab: 切換圖層",t),e.toggleLayerVisibility(t),t&&t.startsWith("service-provider-")){const a=e.findLayerById(t);if(a&&a.visible){const a=t.replace("service-provider-","");console.log("🔘 DateLayersTab: 設置服務人員",a),e.selectedServiceProvider=a}else{const a=t.replace("service-provider-","");e.selectedServiceProvider===a&&(console.log("🔘 DateLayersTab: 清除服務人員選擇"),e.selectedServiceProvider="")}}if(t&&t.startsWith("service-date-")){const a=e.findLayerById(t);if(a&&a.visible){const a=t.replace("service-date-","");console.log("🔘 DateLayersTab: 設置服務日期",a),e.setServiceDateFilter(a)}else{const a=t.replace("service-date-","");e.selectedServiceDate===a&&(console.log("🔘 DateLayersTab: 清除服務日期選擇"),e.clearServiceDateFilter())}}},l=t=>{console.log("🔘 DateLayersTab: 切換群組",t),e.toggleGroupVisibility(t)},s=e=>{if(e.layerId&&e.layerId.startsWith("service-provider-")&&e.geoJsonData){const t=e.geoJsonData.features||[];if(t.length>0){const e=t[0];if(e.properties){if(e.properties.fillColor)return`var(--my-color-${e.properties.fillColor})`;if(e.properties.routeColor)return`var(--my-color-${e.properties.routeColor})`}}}return e.colorName?`var(--my-color-${e.colorName})`:"var(--my-color-gray-300)"},n=async t=>{console.log("📅 DateLayersTab 接收到的日期:",t),console.log("📅 日期長度:",t?t.length:"null"),console.log("📅 預期的民國年格式:",t),e.setSelectedFeature(null),t?(e.setServiceDateFilter(t),console.log("📅 開始載入服務人員圖層"),await e.loadServiceProviderLayers(t)):(e.clearServiceDateFilter(),e.clearServiceProviderLayers())};return(0,i.sV)((async()=>{console.log("🚀 DateLayersTab 組件掛載，開始載入預設日期數據"),await e.loadServiceProviderLayers("1140701")})),{layers:a,toggleLayer:o,toggleGroup:l,isGroupVisible:e.isGroupVisible,layerListRef:t,getIcon:Ve,getLayerColor:s,selectedServiceDate:r,handleDateSelected:n,isDateFilterActive:(0,i.EW)((()=>e.isDateFilterActive))}}};const Ge=(0,u.A)(Qe,[["render",ze],["__scopeId","data-v-5e6ac2c4"]]);var Ye=Ge;const qe={class:"h-100 d-flex flex-column overflow-hidden my-bgcolor-gray-100"},Ze={class:"flex-grow-1 overflow-auto layer-list-container",ref:"layerListRef"},et={class:"mb-3"},tt={class:"p-3"},at={class:"mb-2"},rt={class:"d-flex align-items-center pb-2"},ot={class:"my-title-xs-gray"},it={key:0},lt={key:0,class:"d-flex align-items-center justify-content-center ms-auto"},st=["id","checked","onChange"],nt=["for"],ct=["onClick"],dt={class:"w-100"},ut={class:"d-flex"},pt={class:"d-flex align-items-center text-start w-100 px-3 py-2"},vt={class:"my-content-sm-black"},mt={class:"my-content-xs-gray ms-2"},yt={class:"d-flex align-items-center justify-content-center px-3 py-2"},gt=["id","checked","disabled","onChange"],ht=["for"],ft={key:0,class:"px-3 pb-2"},bt={class:"my-content-xs-black text-nowrap ms-2"};function Lt(e,t,a,r,o,l){const s=(0,i.g2)("ServiceProviderPicker");return(0,i.uX)(),(0,i.CE)("div",qe,[(0,i.Lk)("div",Ze,[(0,i.Lk)("div",et,[(0,i.Lk)("div",tt,[(0,i.Lk)("div",at,[t[1]||(t[1]=(0,i.Lk)("div",{class:"my-title-xs-gray mb-1"},"選擇服務人員",-1)),(0,i.bF)(s,{modelValue:r.selectedServiceProvider,"onUpdate:modelValue":t[0]||(t[0]=e=>r.selectedServiceProvider=e),onProviderSelected:r.handleProviderSelected},null,8,["modelValue","onProviderSelected"])])]),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(r.layers.filter((e=>"服務日期列表"===e.groupName)),(e=>((0,i.uX)(),(0,i.CE)("div",{key:e.groupName,class:"p-3"},[(0,i.Lk)("div",rt,[(0,i.Lk)("div",ot,[(0,i.eW)((0,y.v_)(e.groupName)+" ",1),e.groupLayers.length>0?((0,i.uX)(),(0,i.CE)("span",it," ("+(0,y.v_)(e.groupLayers.length)+") ",1)):(0,i.Q3)("",!0)]),e.groupLayers.length>0?((0,i.uX)(),(0,i.CE)("div",lt,[(0,i.Lk)("input",{type:"checkbox",id:"group-switch-"+e.groupName,checked:r.isGroupVisible(e.groupName),onChange:t=>r.toggleGroup(e.groupName)},null,40,st),(0,i.Lk)("label",{for:"group-switch-"+e.groupName,style:{"--layer-color":"var(--my-color-green)"}},null,8,nt)])):(0,i.Q3)("",!0)]),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(e.groupLayers,(e=>((0,i.uX)(),(0,i.CE)("div",{key:e.layerId,class:"mb-1"},[(0,i.Lk)("div",{class:"btn rounded-0 border-0 d-flex shadow-sm my-bgcolor-white-hover p-0",onClick:t=>r.toggleLayer(e.layerId)},[(0,i.Lk)("div",{class:"d-flex",style:(0,y.Tr)({backgroundColor:r.getLayerColor(e),minWidth:"6px"})},null,4),(0,i.Lk)("div",dt,[(0,i.Lk)("div",ut,[(0,i.Lk)("div",pt,[(0,i.Lk)("span",vt,[(0,i.eW)((0,y.v_)(e.layerName)+" ",1),(0,i.Lk)("span",mt,(0,y.v_)(e.summaryData?.totalCount),1)])]),(0,i.Lk)("div",yt,[(0,i.Lk)("input",{type:"checkbox",id:"switch-"+e.layerId,checked:e.visible,disabled:e.isLoading,onChange:t=>r.toggleLayer(e.layerId)},null,40,gt),(0,i.Lk)("label",{for:"switch-"+e.layerId,style:{"--layer-color":"var(--my-color-green)"}},null,8,ht)])]),e.legendData&&e.visible?((0,i.uX)(),(0,i.CE)("div",ft,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(e.legendData,(e=>((0,i.uX)(),(0,i.CE)("div",{key:e.color,class:"d-flex align-items-center"},[(0,i.Lk)("div",{style:(0,y.Tr)([{"min-width":"6px","min-height":"18px"},{backgroundColor:e.color}])},null,4),(0,i.Lk)("div",bt,(0,y.v_)(e.label),1)])))),128))])):(0,i.Q3)("",!0)])],8,ct)])))),128))])))),128))])],512)])}const wt={class:"service-provider-picker"},kt={key:0,class:"text-center py-2"},xt={key:1,class:"alert alert-warning py-2",role:"alert"},Ct={key:2},_t=["disabled"],St=["value"];function Tt(e,t,a,o,l,s){return(0,i.uX)(),(0,i.CE)("div",wt,[o.isLoading?((0,i.uX)(),(0,i.CE)("div",kt,t[3]||(t[3]=[(0,i.Lk)("div",{class:"spinner-border spinner-border-sm",role:"status"},[(0,i.Lk)("span",{class:"visually-hidden"},"載入中...")],-1),(0,i.Lk)("span",{class:"ms-2 my-content-xs-gray"},"載入服務人員清單...",-1)]))):o.error?((0,i.uX)(),(0,i.CE)("div",xt,[t[5]||(t[5]=(0,i.Lk)("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),(0,i.eW)(" "+(0,y.v_)(o.error)+" ",1),(0,i.Lk)("button",{class:"btn btn-sm btn-outline-warning ms-2",onClick:t[0]||(t[0]=(...e)=>o.loadProviders&&o.loadProviders(...e))},t[4]||(t[4]=[(0,i.Lk)("i",{class:"fas fa-redo"},null,-1),(0,i.eW)(" 重試 ")]))])):((0,i.uX)(),(0,i.CE)("div",Ct,[(0,i.bo)((0,i.Lk)("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>o.selectedProvider=e),onChange:t[2]||(t[2]=e=>o.handleProviderSelected(e.target.value)),class:"form-select form-select-sm px-3 py-2",disabled:o.isLoading},[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(o.availableProviders,(e=>((0,i.uX)(),(0,i.CE)("option",{key:e.id,value:e.id},(0,y.v_)(e.name)+" ("+(0,y.v_)(e.dateCount)+") ",9,St)))),128))],40,_t),[[r.u1,o.selectedProvider]])]))])}var Pt={name:"ServiceProviderPicker",emits:["provider-selected"],setup(e,{emit:t}){const a=_(),r=(0,c.KR)(!1),o=(0,c.KR)(null),l=(0,i.EW)({get:()=>a.selectedServiceProvider,set:e=>{a.setServiceProviderFilter(e)}}),s=(0,i.EW)((()=>a.availableServiceProviders)),n=async()=>{try{r.value=!0,o.value=null,await a.loadAvailableServiceProviders()}catch(e){o.value="載入服務人員清單失敗",console.error("ServiceProviderPicker: 載入服務人員清單失敗",e)}finally{r.value=!1}},d=async e=>{e&&(a.setServiceProviderFilter(e),t("provider-selected",e))};return(0,i.sV)((async()=>{await n()})),{selectedProvider:l,availableProviders:s,isLoading:r,error:o,handleProviderSelected:d,loadProviders:n}}};const It=(0,u.A)(Pt,[["render",Tt],["__scopeId","data-v-dd2dfc9e"]]);var Mt=It,Dt={name:"ServerLayersTab",components:{ServiceProviderPicker:Mt},setup(){const e=_(),t=(0,c.KR)(null),a=(0,i.EW)((()=>e.layers)),r=(0,i.EW)({get:()=>e.selectedServiceProvider,set:t=>{t?e.setServiceProviderFilter(t):e.clearServiceProviderFilter()}}),o=t=>{console.log("🔘 ServerLayersTab: 切換圖層",t),e.toggleLayerVisibility(t)},l=t=>{console.log("🔘 ServerLayersTab: 切換群組",t),e.toggleGroupVisibility(t)},s=e=>{if(e.layerId&&e.layerId.startsWith("service-date-")&&e.geoJsonData){const t=e.geoJsonData.features||[];if(t.length>0){const e=t[0];if(e.properties){if(e.properties.fillColor)return`var(--my-color-${e.properties.fillColor})`;if(e.properties.routeColor)return`var(--my-color-${e.properties.routeColor})`}}}return e.colorName?`var(--my-color-${e.colorName})`:"var(--my-color-gray-300)"},n=async t=>{console.log("👤 ServerLayersTab 接收到的服務人員ID:",t),e.setSelectedFeature(null),t?(e.setServiceProviderFilter(t),console.log("👤 開始載入服務人員日期圖層"),await e.loadServiceProviderDateLayers(t)):(e.clearServiceProviderFilter(),e.clearServiceProviderDateLayers())};return(0,i.sV)((async()=>{console.log("🚀 ServerLayersTab 組件掛載，開始載入服務人員清單");const t=await e.loadAvailableServiceProviders();if(t&&t.length>0){const e=t[0];console.log("👤 預設選擇第一個服務人員:",e.id),await n(e.id)}})),{layers:a,toggleLayer:o,toggleGroup:l,isGroupVisible:e.isGroupVisible,layerListRef:t,getIcon:Ve,getLayerColor:s,selectedServiceProvider:r,handleProviderSelected:n,isServiceProviderFilterActive:(0,i.EW)((()=>e.isServiceProviderFilterActive))}}};const Et=(0,u.A)(Dt,[["render",Lt],["__scopeId","data-v-03b2322c"]]);var $t=Et,Ft={name:"LeftView",components:{DateLayersTab:Ye,ServerLayersTab:$t},props:{selectedServicePoint:{type:Object,default:null}},emits:["clear-service-point-detail"],setup(e,{emit:t}){const a=_(),r=(0,i.EW)((()=>a.activeLeftTab)),o=()=>{t("clear-service-point-detail")},l=e=>{a.setActiveLeftTab(e),a.hideAllLayersOnMap(),a.setSelectedFeature(null)};return{activeLeftTab:r,switchLeftTab:l,clearServicePointDetail:o}}};const zt=(0,u.A)(Ft,[["render",pe]]);var Nt=zt;const Vt={class:"my-right-panel h-100 d-flex flex-column overflow-hidden"},At={class:"flex-grow-1 overflow-auto"},Rt={class:"h-100"};function Wt(e,t,a,o,l,s){const n=(0,i.g2)("PropertiesTab");return(0,i.uX)(),(0,i.CE)("div",Vt,[(0,i.Lk)("div",At,[(0,i.bo)((0,i.Lk)("div",Rt,[(0,i.bF)(n,{onHighlightFeature:t[0]||(t[0]=t=>e.$emit("highlight-feature",t)),onShowServicePointDetail:t[1]||(t[1]=t=>e.$emit("show-service-point-detail",t))})],512),[[r.aG,"properties"===a.activeRightTab]])])])}const Xt={class:"h-100 flex-grow-1 d-flex flex-column my-bgcolor-gray-200"},Bt={key:0,class:"my-bgcolor-white h-100"},Kt={class:"p-3"},Ot={class:"my-title-xs-gray mb-3"},Ht={class:"my-title-xs-gray mb-3"},Ut={class:"my-title-xs-gray mb-3"},jt={class:"table-responsive"},Jt={class:"table table-sm table-hover"},Qt=["onClick"],Gt={class:"text-center"},Yt={class:"badge bg-primary"},qt={class:"fw-bold"},Zt={class:"text-muted"},ea={class:"text-muted small"},ta={class:"my-title-xs-gray mb-3"},aa={class:"pb-2"},ra={class:"my-content-sm-black pb-1"},oa={class:"mb-3"},ia={key:0},la={class:"pb-2"},sa={class:"my-content-sm-black pb-1"},na={key:1,class:"text-muted small"},ca={class:"pb-2"},da={class:"my-title-xs-gray pb-1"},ua={key:0,class:"pb-1"},pa={class:"table-responsive"},va={class:"table w-100 mb-0"},ma={class:"border-0 text-nowrap text-truncate p-0",style:{"max-width":"80px"}},ya={class:"my-content-xs-black px-3 py-2"},ga={class:"border-0 text-nowrap text-truncate p-0",style:{"max-width":"80px"}},ha={class:"my-content-xs-black px-3 py-2"},fa={class:"border-0 text-nowrap text-truncate p-0",style:{"max-width":"80px"}},ba={class:"my-content-xs-black px-3 py-2"},La={class:"border-0 text-nowrap text-truncate p-0",style:{"max-width":"80px"}},wa={class:"my-content-xs-black px-3 py-2"},ka={key:1,class:"text-muted"},xa={key:1,class:"flex-grow-1 d-flex align-items-center justify-content-center"};function Ca(e,t,a,r,o,l){const s=(0,i.g2)("DetailItem");return(0,i.uX)(),(0,i.CE)("div",Xt,[r.selectedFeature?((0,i.uX)(),(0,i.CE)("div",Bt,[(0,i.Lk)("div",null,[r.selectedLayer?((0,i.uX)(),(0,i.CE)("div",{key:0,style:(0,y.Tr)({backgroundColor:r.selectedLayerColor,minHeight:"4px"})},null,4)):(0,i.Q3)("",!0),(0,i.Lk)("div",Kt,[(0,i.bF)(s,{label:r.firstLabel,value:r.firstValue},null,8,["label","value"]),(0,i.bF)(s,{label:r.secondLabel,value:r.secondValue},null,8,["label","value"]),r.hasProperties?((0,i.uX)(!0),(0,i.CE)(i.FK,{key:0},(0,i.pI)(r.selectedFeature.properties.propertyData,((e,t)=>((0,i.uX)(),(0,i.Wv)(s,{key:t,label:l.formatLabel(t),value:l.formatValue(e)},null,8,["label","value"])))),128)):(0,i.Q3)("",!0),r.isAnalysisObject&&(r.pointsInRange.length>0||r.polygonInRange.length>0)?((0,i.uX)(),(0,i.CE)(i.FK,{key:1},[r.pointsInRange.length>0?((0,i.uX)(),(0,i.CE)(i.FK,{key:0},[t[0]||(t[0]=(0,i.Lk)("hr",{class:"my-3"},null,-1)),(0,i.Lk)("div",Ot,"範圍內點物件 "+(0,y.v_)(r.pointsInRange.length),1),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(r.pointsInRange,((e,t)=>((0,i.uX)(),(0,i.Wv)(s,{key:t,label:e.properties.layerName,value:`${e.properties.name} (${e.distance}m)`},null,8,["label","value"])))),128))],64)):(0,i.Q3)("",!0),r.polygonInRange.length>0?((0,i.uX)(),(0,i.CE)(i.FK,{key:1},[t[1]||(t[1]=(0,i.Lk)("hr",{class:"my-3"},null,-1)),(0,i.Lk)("div",Ht,"範圍內面域物件 "+(0,y.v_)(r.polygonInRange.length),1),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(r.polygonInRange,((e,t)=>((0,i.uX)(),(0,i.Wv)(s,{key:t,label:e.properties.layerName,value:e.properties.name},null,8,["label","value"])))),128))],64)):(0,i.Q3)("",!0)],64)):(0,i.Q3)("",!0),r.isServiceProviderObject&&r.selectedFeature.properties.allServicePoints?((0,i.uX)(),(0,i.CE)(i.FK,{key:2},[t[6]||(t[6]=(0,i.Lk)("hr",{class:"my-3"},null,-1)),t[7]||(t[7]=(0,i.Lk)("div",{class:"my-title-xs-gray mb-3"},"服務人員信息",-1)),(0,i.bF)(s,{label:"服務人員身分證",value:r.serviceProviderLabel},null,8,["value"]),(0,i.bF)(s,{label:"服務日期",value:r.serviceDateLabel||"無資料"},null,8,["value"]),(0,i.bF)(s,{label:"服務點位數",value:`${r.selectedFeature.properties.allServicePoints.length} 個`},null,8,["value"]),r.selectedFeature.properties.allServicePoints.length>0?((0,i.uX)(),(0,i.CE)(i.FK,{key:0},[t[5]||(t[5]=(0,i.Lk)("hr",{class:"my-3"},null,-1)),(0,i.Lk)("div",Ut," 個案列表 ("+(0,y.v_)(r.selectedFeature.properties.allServicePoints.length)+" 個) ",1),(0,i.Lk)("div",jt,[(0,i.Lk)("table",Jt,[t[2]||(t[2]=(0,i.Lk)("thead",{class:"table-light"},[(0,i.Lk)("tr",null,[(0,i.Lk)("th",{style:{width:"50px"}},"順序"),(0,i.Lk)("th",{style:{width:"80px"}},"姓名"),(0,i.Lk)("th",{style:{width:"100px"}},"時間"),(0,i.Lk)("th",null,"地址")])],-1)),(0,i.Lk)("tbody",null,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(r.selectedFeature.properties.allServicePoints,((e,t)=>((0,i.uX)(),(0,i.CE)("tr",{key:t,onClick:t=>r.selectServicePoint(e)},[(0,i.Lk)("td",Gt,[(0,i.Lk)("span",Yt,(0,y.v_)(e.順序),1)]),(0,i.Lk)("td",qt,(0,y.v_)(e.姓名),1),(0,i.Lk)("td",Zt,(0,y.v_)(e.時間),1),(0,i.Lk)("td",ea,(0,y.v_)(e.地址),1)],8,Qt)))),128))])])]),r.selectedServicePoint?((0,i.uX)(),(0,i.CE)(i.FK,{key:0},[t[4]||(t[4]=(0,i.Lk)("hr",{class:"my-3"},null,-1)),(0,i.Lk)("div",ta," 個案詳細信息 - "+(0,y.v_)(r.selectedServicePoint.姓名),1),(0,i.bF)(s,{label:"編號",value:r.selectedServicePoint.編號},null,8,["value"]),(0,i.Lk)("div",aa,[t[3]||(t[3]=(0,i.Lk)("div",{class:"my-title-xs-gray pb-1"},"姓名",-1)),(0,i.Lk)("div",ra,[(0,i.Lk)("span",{class:(0,y.C4)("男性"===r.selectedServicePoint.性別?"my-color-blue":"女性"===r.selectedServicePoint.性別?"my-color-red":"")},[(0,i.eW)((0,y.v_)(r.selectedServicePoint.姓名),1),"男性"===r.selectedServicePoint.性別?((0,i.uX)(),(0,i.CE)(i.FK,{key:0},[(0,i.eW)(" (M)")],64)):"女性"===r.selectedServicePoint.性別?((0,i.uX)(),(0,i.CE)(i.FK,{key:1},[(0,i.eW)(" (F)")],64)):(0,i.Q3)("",!0)],2)])]),(0,i.bF)(s,{label:"身分證字號",value:r.selectedServicePoint.身分證字號||"無資料"},null,8,["value"]),(0,i.bF)(s,{label:"個案戶籍地址",value:r.selectedServicePoint.個案戶籍地址},null,8,["value"]),(0,i.bF)(s,{label:"個案居住地址",value:r.selectedServicePoint.個案居住地址||r.selectedServicePoint.地址},null,8,["value"])],64)):(0,i.Q3)("",!0)],64)):(0,i.Q3)("",!0)],64)):(0,i.Q3)("",!0),r.isServiceItemsObject?((0,i.uX)(),(0,i.CE)(i.FK,{key:3},[t[11]||(t[11]=(0,i.Lk)("hr",{class:"my-3"},null,-1)),t[12]||(t[12]=(0,i.Lk)("div",{class:"my-title-sm-black mb-2"},"服務點資料",-1)),(0,i.Lk)("div",oa,[r.selectedFeature.properties.detail?((0,i.uX)(),(0,i.CE)("div",ia,[(0,i.bF)(s,{label:"編號",value:r.selectedFeature.properties.detail.編號||"無資料"},null,8,["value"]),(0,i.Lk)("div",la,[t[8]||(t[8]=(0,i.Lk)("div",{class:"my-title-xs-gray pb-1"},"姓名",-1)),(0,i.Lk)("div",sa,[(0,i.Lk)("span",{class:(0,y.C4)("男性"===r.selectedFeature.properties.detail.性別?"my-color-blue":"女性"===r.selectedFeature.properties.detail.性別?"my-color-red":"")},[(0,i.eW)((0,y.v_)(r.selectedFeature.properties.detail.姓名||"無資料")+" ",1),"男性"===r.selectedFeature.properties.detail.性別?((0,i.uX)(),(0,i.CE)(i.FK,{key:0},[(0,i.eW)(" (M)")],64)):"女性"===r.selectedFeature.properties.detail.性別?((0,i.uX)(),(0,i.CE)(i.FK,{key:1},[(0,i.eW)(" (F)")],64)):(0,i.Q3)("",!0)],2)])]),(0,i.bF)(s,{label:"身分證字號",value:r.selectedFeature.properties["身分證字號"]||(Array.isArray(r.selectedFeature.properties.serviceItems)?r.selectedFeature.properties.serviceItems[0]?.["身分證字號"]:null)||(Array.isArray(r.selectedFeature.properties.service_items)?r.selectedFeature.properties.service_items[0]?.["身分證字號"]:null)||"無資料"},null,8,["value"]),(0,i.bF)(s,{label:"個案戶籍地址",value:r.selectedFeature.properties.detail.個案戶籍地址||"無資料"},null,8,["value"]),(0,i.bF)(s,{label:"個案居住地址",value:r.selectedFeature.properties.detail.個案居住地址||"無資料"},null,8,["value"])])):((0,i.uX)(),(0,i.CE)("div",na,"此服務點缺少 detail 資料")),(0,i.Lk)("div",ca,[(0,i.Lk)("div",da," 服務項目列表 ("+(0,y.v_)(r.selectedFeature.properties.serviceItems.length)+") ",1),r.selectedFeature.properties.serviceItems.length>0?((0,i.uX)(),(0,i.CE)("div",ua,[(0,i.Lk)("div",pa,[(0,i.Lk)("table",va,[t[9]||(t[9]=(0,i.Lk)("thead",{class:"sticky-top my-table-thead"},[(0,i.Lk)("tr",{class:"text-center text-nowrap"},[(0,i.Lk)("th",{class:"p-1"},[(0,i.Lk)("span",{class:"my-title-xs-gray text-nowrap"},"服務項目代碼")]),(0,i.Lk)("th",{class:"p-1"},[(0,i.Lk)("span",{class:"my-title-xs-gray text-nowrap"},"單價")]),(0,i.Lk)("th",{class:"p-1"},[(0,i.Lk)("span",{class:"my-title-xs-gray text-nowrap"},"服務時間")]),(0,i.Lk)("th",{class:"p-1"},[(0,i.Lk)("span",{class:"my-title-xs-gray text-nowrap"},"總時間")])])],-1)),(0,i.Lk)("tbody",null,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(r.selectedFeature.properties.serviceItems,((e,t)=>((0,i.uX)(),(0,i.CE)("tr",{key:e.row_id||t,class:"text-center text-nowrap border-bottom"},[(0,i.Lk)("td",ma,[(0,i.Lk)("div",ya,(0,y.v_)(e.服務項目代碼||"N/A"),1)]),(0,i.Lk)("td",ga,[(0,i.Lk)("div",ha,(0,y.v_)(e.單價||e.unitPrice||"N/A"),1)]),(0,i.Lk)("td",fa,[(0,i.Lk)("div",ba,(0,y.v_)(`${e.hour_start||"N/A"}:${(e.min_start||0).toString().padStart(2,"0")} - ${e.hour_end||"N/A"}:${(e.min_end||0).toString().padStart(2,"0")}`),1)]),(0,i.Lk)("td",La,[(0,i.Lk)("div",wa,(0,y.v_)((e.hour_total||0)>0?`${e.hour_total||0}h`:"")+(0,y.v_)(e.min_total||0)+"m ",1)])])))),128))])])])])):((0,i.uX)(),(0,i.CE)("div",ka,t[10]||(t[10]=[(0,i.Lk)("i",{class:"fas fa-info-circle me-2"},null,-1),(0,i.eW)(" 此服務點沒有服務項目記錄 ")])))])])],64)):(0,i.Q3)("",!0),r.isRouteCenterPointObject?((0,i.uX)(),(0,i.CE)(i.FK,{key:4},[t[13]||(t[13]=(0,i.Lk)("hr",{class:"my-3"},null,-1)),t[14]||(t[14]=(0,i.Lk)("div",{class:"my-title-sm-black mb-3"},"路線中心點資訊",-1)),(0,i.bF)(s,{label:"服務人員身分證",value:r.serviceProviderLabel},null,8,["value"]),(0,i.bF)(s,{label:"服務日期",value:r.serviceDateLabel||"無資料"},null,8,["value"]),(0,i.bF)(s,{label:"中心點編號",value:r.selectedFeature.properties.centerIndex},null,8,["value"]),(0,i.bF)(s,{label:"緯度",value:r.selectedFeature.properties.緯度?.toFixed(6)||"無資料"},null,8,["value"]),(0,i.bF)(s,{label:"經度",value:r.selectedFeature.properties.經度?.toFixed(6)||"無資料"},null,8,["value"]),t[15]||(t[15]=(0,i.Fv)('<hr class="my-2" data-v-59855172><div class="my-content-xs-gray" data-v-59855172><div class="mb-1" data-v-59855172><i class="fas fa-star me-2 text-warning" data-v-59855172></i> 此點為服務人員路線的中心位置 </div><div class="mb-1" data-v-59855172><i class="fas fa-info-circle me-2 text-info" data-v-59855172></i> 中心點座標來自系統計算的路線幾何中心 </div></div>',2))],64)):(0,i.Q3)("",!0)])])])):((0,i.uX)(),(0,i.CE)("div",xa,t[16]||(t[16]=[(0,i.Lk)("div",{class:"text-center"},[(0,i.Lk)("div",{class:"my-title-md-gray p-3"},"沒有點擊地圖上的物件")],-1)])))])}const _a={class:"pb-2"},Sa={class:"my-title-xs-gray pb-1"},Ta={class:"my-content-sm-black pb-1"};function Pa(e,t,a,r,o,l){return(0,i.uX)(),(0,i.CE)("div",_a,[(0,i.Lk)("div",Sa,(0,y.v_)(a.label),1),(0,i.Lk)("div",Ta,(0,y.v_)(a.value),1)])}var Ia={name:"DetailItem",props:{label:{type:String,required:!0},value:{type:[String,Number,Boolean,Object],required:!0}}};const Ma=(0,u.A)(Ia,[["render",Pa],["__scopeId","data-v-0cd54acc"]]);var Da=Ma,Ea={name:"PropertiesTab",components:{DetailItem:Da},setup(){const e=_(),t=(0,i.EW)((()=>e.selectedFeature)),a=(0,i.EW)((()=>{if(!t.value?.properties?.layerId)return null;const a=t.value.properties.layerId,r=e.findLayerById(a);return r})),r=(0,i.EW)((()=>{const e=a.value;if(!e)return"var(--my-color-gray-300)";if(e.geoJsonData&&e.geoJsonData.features&&e.geoJsonData.features.length>0){const t=e.geoJsonData.features.find((e=>e.properties&&(e.properties.fillColor||e.properties.routeColor)))||e.geoJsonData.features[0],a=t.properties||{};if(a.fillColor)return`var(--my-color-${a.fillColor})`;if(a.routeColor)return`var(--my-color-${a.routeColor})`}return e.colorName?`var(--my-color-${e.colorName})`:"var(--my-color-gray-300)"})),o=(0,i.EW)((()=>{if(!t.value?.properties?.layerId)return null;const a=t.value.properties.layerId,r=e.findLayerById(a);return r?r.layerName:a})),l=(0,i.EW)((()=>{if(f.value){const e=f.value;if(e.serviceProviderId)return e.serviceProviderId;if(e["服務人員身分證"])return e["服務人員身分證"];if(e.detail?.["服務人員身分證"])return e.detail["服務人員身分證"]}if(t.value?.properties){const e=t.value.properties;if(e.serviceProviderId)return e.serviceProviderId;if(e.服務人員身分證)return e.服務人員身分證;if(e.detail?.服務人員身分證)return e.detail.服務人員身分證}return e.selectedServiceProvider?e.selectedServiceProvider:e.isDateFilterActive&&!e.isServiceProviderFilterActive?"所有服務人員":"未選擇"})),s=(0,i.EW)((()=>{if(f.value){const e=f.value;if(e.serviceDate)return e.serviceDate;if(e["服務日期(請輸入7碼)"])return e["服務日期(請輸入7碼)"];if(e.服務日期)return e.服務日期;if(e.detail?.["服務日期(請輸入7碼)"])return e.detail["服務日期(請輸入7碼)"];if(e.detail?.服務日期)return e.detail.服務日期}if(t.value?.properties){const e=t.value.properties;if(e.serviceDate)return e.serviceDate;if(e["服務日期(請輸入7碼)"])return e["服務日期(請輸入7碼)"];if(e.detail?.["服務日期(請輸入7碼)"])return e.detail["服務日期(請輸入7碼)"];if(e.服務日期)return e.服務日期;if(e.detail?.服務日期)return e.detail.服務日期}return e.selectedServiceDate?e.selectedServiceDate:e.isServiceProviderFilterActive?"所有日期":"未選擇"})),n=(0,i.EW)((()=>"date"===e.activeLeftTab?"服務日期":"服務人員")),d=(0,i.EW)((()=>"date"===e.activeLeftTab?"服務人員":"服務日期")),u=(0,i.EW)((()=>"date"===e.activeLeftTab?s.value:l.value)),p=(0,i.EW)((()=>"date"===e.activeLeftTab?l.value:s.value)),v=(0,i.EW)((()=>!!t.value?.properties?.propertyData&&Object.keys(t.value.properties.propertyData).length>0)),m=(0,i.EW)((()=>"analysis-layer"===t.value?.properties?.layerId)),y=(0,i.EW)((()=>"service-provider"===t.value?.properties?.type)),g=(0,i.EW)((()=>"route-center-point-selected"===t.value?.properties?.type)),h=(0,i.EW)((()=>{const e=t.value?.properties,a=e?.type,r=e?.serviceItems,o=r?.length,i="service-items"===a&&Array.isArray(r)&&o>0;return i})),f=(0,c.KR)(null),b=e=>{f.value=e},L=(0,i.EW)((()=>m.value&&t.value?.properties?.pointsInRange||[])),w=(0,i.EW)((()=>m.value&&t.value?.properties?.polygonInRange||[])),k=(0,i.EW)((()=>{const e=L.value.map((e=>({...e,objectType:"point"}))),t=w.value.map((e=>({...e,objectType:"polygon"})));return[...e,...t]})),x=(0,i.EW)((()=>m.value&&t.value?.properties?.layerStats||{})),C=(0,i.EW)((()=>m.value&&t.value?.properties?.polygonStats||{})),S=(0,i.EW)((()=>{const e={...x.value};return Object.entries(C.value).forEach((([t,a])=>{const r=`${t} (多邊形)`;e[r]=a})),e})),T=e=>{if(!e)return"N/A";try{return new Date(e).toLocaleString("zh-TW")}catch(t){return console.warn("日期格式化失敗:",t),e}};return{selectedFeature:t,selectedLayer:a,selectedLayerColor:r,layerName:o,serviceProviderLabel:l,serviceDateLabel:s,firstLabel:n,secondLabel:d,firstValue:u,secondValue:p,hasProperties:v,isAnalysisObject:m,isServiceProviderObject:y,isServiceItemsObject:h,isRouteCenterPointObject:g,selectedServicePoint:f,selectServicePoint:b,pointsInRange:L,polygonInRange:w,allObjectsInRange:k,layerStats:x,polygonStats:C,combinedStats:S,formatDateTime:T,selectedServiceDate:(0,i.EW)((()=>e.selectedServiceDate))}},methods:{formatLabel(e){const t={PTVNAME:"區域名稱","中位數":"中位數",name:"名稱",count:"數量",area:"面積",population:"人口",density:"密度","分析點名稱":"分析點名稱","分析範圍名稱":"分析範圍名稱","緯度":"緯度","經度":"經度","中心緯度":"中心緯度","中心經度":"中心經度","分析半徑":"分析半徑","建立時間":"建立時間","關聯分析點":"關聯分析點"};return t[e]||e},formatValue(e){return"number"===typeof e?e.toLocaleString():e}}};const $a=(0,u.A)(Ea,[["render",Ca],["__scopeId","data-v-59855172"]]);var Fa=$a,za={name:"RightView",components:{PropertiesTab:Fa},props:{activeRightTab:{type:String,default:"results"},analysisList:{type:Array,default:()=>[]},selectedAnalysisId:{type:[Number,String],default:null},rightViewWidth:{type:Number,default:250}},emits:["update:activeRightTab","select-analysis","view-analysis","delete-analysis","highlight-feature","show-service-point-detail"],setup(e){const t=_(),a=()=>e.analysisList.filter((e=>"完成"===e.status)).length;(0,i.wB)((()=>t.selectedFeature),(e=>{console.log("RightView - selectedFeature changed:",{newFeature:e,properties:e?.properties,store:t})}),{immediate:!0});const r=(0,i.EW)((()=>{const e=t.selectedFeature;return console.log("RightView - Computing selectedFeature:",{feature:e,properties:e?.properties}),e}));return{getActiveAnalysisCount:a,selectedFeature:r}}};const Na=(0,u.A)(za,[["render",Wt]]);var Va=Na;const Aa={class:"d-flex flex-column my-bgcolor-gray-200 h-100"},Ra={class:"flex-grow-1 overflow-hidden position-relative"},Wa={class:"position-absolute top-0 start-0 m-3",style:{"z-index":"1000"}},Xa={class:"d-flex align-items-center rounded-pill shadow my-blur gap-1 p-2"},Ba={class:"h-100"},Ka={ref:"dashboardContainerRef",class:"h-100 overflow-auto pt-5"};function Oa(e,t,a,o,l,s){const n=(0,i.g2)("MapTab"),c=(0,i.g2)("DashboardTab");return(0,i.uX)(),(0,i.CE)("div",Aa,[(0,i.Lk)("div",Ra,[(0,i.Lk)("div",Wa,[(0,i.Lk)("div",Xa,[(0,i.Lk)("button",{class:(0,y.C4)(["btn rounded-circle border-0 d-flex align-items-center justify-content-center my-btn-transparent my-font-size-xs",{"my-btn-blue":"map"===a.activeUpperTab}]),onClick:t[0]||(t[0]=t=>e.$emit("update:activeUpperTab","map")),style:{width:"30px",height:"30px"},title:"地圖視圖"},t[6]||(t[6]=[(0,i.Lk)("i",{class:"fas fa-map"},null,-1)]),2),(0,i.Lk)("button",{class:(0,y.C4)(["btn rounded-circle border-0 d-flex align-items-center justify-content-center my-btn-transparent my-font-size-xs",{"my-btn-blue":"dashboard"===a.activeUpperTab}]),onClick:t[1]||(t[1]=t=>e.$emit("update:activeUpperTab","dashboard")),style:{width:"30px",height:"30px"},title:"資料儀表板"},t[7]||(t[7]=[(0,i.Lk)("i",{class:"fas fa-chart-bar"},null,-1)]),2)])]),(0,i.bo)((0,i.Lk)("div",Ba,[(0,i.bF)(n,{ref:"MapTab",showTainanLayer:a.showTainanLayer,selectedFilter:a.selectedFilter,zoomLevel:a.zoomLevel,maxCount:e.maxCount,"onUpdate:zoomLevel":t[2]||(t[2]=t=>e.$emit("update:zoomLevel",t)),"onUpdate:currentCoords":t[3]||(t[3]=t=>e.$emit("update:currentCoords",t)),"onUpdate:activeMarkers":t[4]||(t[4]=t=>e.$emit("update:activeMarkers",t)),onShowServicePointDetail:t[5]||(t[5]=t=>e.$emit("show-service-point-detail",t))},null,8,["showTainanLayer","selectedFilter","zoomLevel","maxCount"])],512),[[r.aG,"map"===a.activeUpperTab]]),(0,i.bo)((0,i.Lk)("div",Ka,[t[8]||(t[8]=(0,i.Lk)("div",{style:{height:"40px"}},null,-1)),(0,i.bF)(c,{ref:"DashboardTab",containerHeight:a.contentHeight,isPanelDragging:a.isPanelDragging,activeMarkers:a.activeMarkers},null,8,["containerHeight","isPanelDragging","activeMarkers"])],512),[[r.aG,"dashboard"===a.activeUpperTab]])])])}const Ha=["id"],Ua={class:"position-absolute map-bottom-controls d-flex align-items-center rounded-pill shadow my-blur gap-2 p-2 mb-3"},ja={class:"d-flex align-items-center"},Ja={class:"dropdown dropup"},Qa={class:"btn rounded-pill border-0 my-btn-transparent my-font-size-xs text-nowrap",type:"button","data-bs-toggle":"dropdown","aria-expanded":"false"},Ga={class:"dropdown-menu"},Ya=["onClick"],qa=["disabled"];function Za(e,t,a,o,l,s){return(0,i.uX)(),(0,i.CE)("div",{id:"map-container",class:(0,y.C4)(["h-100 w-100 position-relative",{"route-planning-click-mode-active":e.isRoutePlanningClickMode,"route-optimization-click-mode-active":e.isRouteOptimizationClickMode}]),onHighlightOnMap:t[5]||(t[5]=(...e)=>o.highlightFeature&&o.highlightFeature(...e))},[(0,i.Lk)("div",{id:o.mapContainerId,ref:"mapContainer",class:"h-100 w-100"},null,8,Ha),o.showContextMenu?((0,i.uX)(),(0,i.CE)("div",{key:0,ref:"contextMenu",class:"position-fixed rounded my-bgcolor-white my-font-size-sm shadow-sm",style:(0,y.Tr)({left:o.contextMenuPosition.x+"px",top:o.contextMenuPosition.y+"px",zIndex:1e4}),onClick:t[1]||(t[1]=(0,r.D$)((()=>{}),["stop"]))},[(0,i.Lk)("div",{class:"context-menu-item d-flex align-items-center my-bgcolor-white-hover my-title-sm-black px-3 py-2 my-2",onClick:t[0]||(t[0]=(...e)=>o.deleteAnalysisPoint&&o.deleteAnalysisPoint(...e))},t[6]||(t[6]=[(0,i.Lk)("span",{class:"my-color-red"},[(0,i.Lk)("i",{class:"fas fa-trash-alt me-2"})],-1),(0,i.eW)(" 刪除此分析點 ")]))],4)):(0,i.Q3)("",!0),o.showContextMenu?((0,i.uX)(),(0,i.CE)("div",{key:1,class:"context-menu-overlay position-fixed w-100 h-100",style:{top:"0",left:"0","z-index":"9999"},onClick:t[2]||(t[2]=(...e)=>o.hideContextMenu&&o.hideContextMenu(...e))})):(0,i.Q3)("",!0),(0,i.Lk)("div",Ua,[(0,i.Lk)("div",ja,[(0,i.Lk)("div",Ja,[(0,i.Lk)("button",Qa,(0,y.v_)(o.getBasemapLabel(o.selectedBasemap)),1),(0,i.Lk)("ul",Ga,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(o.mapStore.basemaps,(e=>((0,i.uX)(),(0,i.CE)("li",{key:e.value},[(0,i.Lk)("a",{class:"dropdown-item my-content-xs-black py-1",href:"#",onClick:(0,r.D$)((t=>o.changeBasemap(e.value)),["prevent"])},(0,y.v_)(e.label),9,Ya)])))),128))])])]),(0,i.Lk)("button",{class:"btn rounded-pill border-0 my-btn-transparent my-font-size-xs text-nowrap my-cursor-pointer",onClick:t[3]||(t[3]=(...e)=>o.showAllFeatures&&o.showAllFeatures(...e)),disabled:!o.isAnyLayerVisible,title:"顯示圖面所有資料範圍"}," 顯示全部 ",8,qa),(0,i.Lk)("button",{class:"btn rounded-pill border-0 my-btn-transparent my-font-size-xs text-nowrap my-cursor-pointer",onClick:t[4]||(t[4]=(...e)=>o.showFullCity&&o.showFullCity(...e)),title:"回到預設地圖範圍"}," 顯示全市 ")])],34)}var er=a(6886),tr=a.n(er);const ar=(0,o.nY)("define",{state:()=>({selectedBasemap:"carto_light_labels",mapView:{center:[24.1477,120.6736],zoom:11},basemaps:[{label:"OpenStreetMap",value:"osm",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"},{label:"Esri Street",value:"esri_street",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}"},{label:"Esri Topo",value:"esri_topo",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}"},{label:"Esri World Imagery",value:"esri_imagery",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"},{label:"Google Maps 街道",value:"google_road",url:"https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}"},{label:"Google Maps 衛星",value:"google_satellite",url:"https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}"},{label:"國土規劃中心電子地圖",value:"nlsc_emap",url:"https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}"},{label:"國土規劃中心正射影像",value:"nlsc_photo",url:"https://wmts.nlsc.gov.tw/wmts/PHOTO2/default/GoogleMapsCompatible/{z}/{y}/{x}"},{label:"地形圖",value:"terrain",url:"https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png"},{label:"Carto Light",value:"carto_light_labels",url:"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"},{label:"Carto Dark",value:"carto_dark_labels",url:"https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"},{label:"Carto Voyager",value:"carto_voyager",url:"https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png"},{label:"白色地圖",value:"blank",url:""},{label:"黑色底圖",value:"black",url:""}]}),actions:{setSelectedBasemap(e){this.selectedBasemap=e},setMapView(e,t){this.mapView.center=e,this.mapView.zoom=t}}});var rr=a(7024),or=a(1071),ir=a(8249);delete tr().Icon.Default.prototype._getIconUrl,tr().Icon.Default.mergeOptions({iconRetinaUrl:ir,iconUrl:rr,shadowUrl:or});var lr={name:"MapTab",props:{zoomLevel:{type:Number,default:11},isPanelDragging:{type:Boolean,default:!1}},emits:["update:zoomLevel","update:currentCoords","update:activeMarkers","show-service-point-detail"],setup(e,{emit:t}){const a=_(),r=ar(),o=(0,c.KR)(null);let l=null,s=null,n={};const d=(0,c.KR)(null),u=(0,c.KR)(!1),p=(0,c.KR)({x:0,y:0}),v=(0,c.KR)(null),m=(0,c.KR)(!1),y=(0,c.KR)(`leaflet-map-${Math.random().toString(36).substr(2,9)}`);let g=null;const h=e=>{const t=e.姓名||e.name||"",a=e.性別||e.gender||"",r="男性"===a?"M":"女性"===a?"F":"",o="男性"===a?"my-color-blue":"女性"===a?"my-color-red":"",i=t&&r?`${t}(${r})`:t;return`\n          <div>\n            <div class="pb-2">\n              <div class="my-title-xs-gray pb-1">編號</div>\n              <div class="my-content-sm-black pb-1">${e.編號||e.id||"N/A"}</div>\n            </div>\n            <div class="pb-2">\n              <div class="my-title-xs-gray pb-1">姓名</div>\n              <div class="my-content-sm-black pb-1"><span class="${o}">${i||"N/A"}</span></div>\n            </div>\n            <div class="pb-2">\n              <div class="my-title-xs-gray pb-1">個案居住地址</div>\n              <div class="my-content-sm-black pb-1">${e.個案居住地址||e.address||"N/A"}</div>\n            </div>\n          </div>`},f=(0,i.EW)((()=>a.getAllLayers().some((e=>e.visible&&e.geoJsonData)))),b=()=>{if(console.log("[MapTab] createMap 被調用"),!o.value)return console.error("[MapTab] 地圖容器不存在，無法創建地圖"),!1;if(l)return console.warn("[MapTab] 地圖實例已存在，跳過創建"),!0;const e=o.value.getBoundingClientRect();if(console.log("[MapTab] 容器尺寸:",{width:e.width,height:e.height,top:e.top,left:e.left,containerId:o.value.id,containerClasses:o.value.className}),0===e.width||0===e.height)return console.error("[MapTab] 容器尺寸無效，無法創建地圖",{width:e.width,height:e.height}),!1;if("undefined"===typeof tr())return console.error("[MapTab] Leaflet 庫未載入"),!1;try{console.log("[MapTab] 開始創建 Leaflet 地圖實例"),l=tr().map(o.value,{center:r.mapView.center,zoom:r.mapView.zoom,zoomControl:!1,attributionControl:!1,fadeAnimation:!0,zoomAnimation:!0}),console.log("[MapTab] Leaflet 地圖實例創建成功"),l.on("zoomend",L),l.on("moveend",w),l.on("click",(function(e){e.originalEvent.target.closest(".leaflet-interactive")||(console.log("🎯 MapTab: 點擊空白處，清除選取和高亮顯示"),l.eachLayer((e=>{e.options&&e.options.icon&&("first-service-point-marker"===e.options.icon.options?.className||"highlight-service-point-marker"===e.options.icon.options?.className)&&l.removeLayer(e)})),a.setSelectedFeature(null),T())}));const e=l.getPane("popupPane");return e&&(e.style.zIndex=2200),m.value=!0,console.log("[MapTab] 地圖創建成功，初始化完成"),!0}catch(t){if(console.error("[MapTab] 地圖創建失敗:",t),l){try{l.remove()}catch(i){console.warn("[MapTab] 清理失敗的地圖實例時發生錯誤:",i)}l=null}return!1}},L=()=>{if(l){const e=l.getZoom(),a=l.getCenter();r.setMapView([a.lat,a.lng],e),t("update:zoomLevel",e)}},w=()=>{if(l){const e=l.getCenter(),a=l.getZoom();r.setMapView([e.lat,e.lng],a),t("update:currentCoords",e)}},k=()=>{if(!l||!m.value)return;s&&(l.removeLayer(s),s=null);const e=r.basemaps.find((e=>e.value===r.selectedBasemap));e&&e.url&&(s=tr().tileLayer(e.url,{attribution:""}),s.addTo(l));const t=o.value;t&&("blank"===r.selectedBasemap?t.style.backgroundColor="var(--my-color-white)":"black"===r.selectedBasemap?t.style.backgroundColor="var(--my-color-gray-800)":t.style.backgroundColor="transparent")},x=e=>{if(!e.geoJsonData)return null;const{layerName:r,colorName:o,type:i}=e,s=e.layerId,n=e.layerName,c=tr().geoJSON(e.geoJsonData,{pointToLayer:(t,a)=>{if(e.isAnalysisLayer){if("point-analysis"===t.properties.type){const e=tr().divIcon({html:'\n                  <div class="d-flex align-items-center justify-content-center my-color-green my-font-size-sm">\n                    <i class="fas fa-plus"></i>\n                  </div>\n                  ',className:"analysis-point-icon",iconSize:[16,16],iconAnchor:[8,8],popupAnchor:[0,-8]}),t=tr().marker(a,{icon:e});return t}if("circle-analysis"===t.properties.type){const e=tr().circle(a,{radius:t.properties.radius,color:"var(--my-color-green)",weight:1,opacity:.8,fillColor:"var(--my-color-green)",fillOpacity:.2});return e}}else if(e.isRoutePlanningLayer){if("route-planning-point"===t.properties.type){const e=t.properties.order||1,r="completed"===t.properties.status,o=r?"var(--my-color-gray-500)":"var(--my-color-orange)",i=r?"var(--my-color-gray-400)":"white",l=r?"var(--my-color-gray-200)":"var(--my-color-white)",s=tr().divIcon({html:`\n                  <div class="d-flex align-items-center justify-content-center my-font-size-xs fw-bold"\n                       style="background: ${o}; color: ${l}; border-radius: 50%; width: 20px; height: 20px; border: 2px solid ${i}; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">\n                    ${e}\n                  </div>\n                  `,className:"route-planning-point-icon "+(r?"completed":"active"),iconSize:[24,24],iconAnchor:[12,12],popupAnchor:[0,-12]}),n=tr().marker(a,{icon:s});return n}}else if(e.isRouteOptimizationLayer){if("optimization-point"===t.properties.type){const e=t.properties.order||1,r="completed"===t.properties.status,o=r?"var(--my-color-gray-500)":"var(--my-color-purple)",i=r?"var(--my-color-gray-400)":"white",l=r?"var(--my-color-gray-200)":"var(--my-color-white)",s=tr().divIcon({html:`\n                  <div class="d-flex align-items-center justify-content-center my-font-size-xs fw-bold"\n                       style="background: ${o}; color: ${l}; border-radius: 50%; width: 20px; height: 20px; border: 2px solid ${i}; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">\n                    ${e}\n                  </div>\n                  `,className:"route-optimization-point-icon "+(r?"completed":"active"),iconSize:[24,24],iconAnchor:[12,12],popupAnchor:[0,-12]}),n=tr().marker(a,{icon:s});return n}}else if("point"===i){if("route-center-point"===t.properties.type){let e=`var(--my-color-${o})`;t.properties.fillColor?e=`var(--my-color-${t.properties.fillColor})`:t.properties.routeColor&&(e=`var(--my-color-${t.properties.routeColor})`);const r=(()=>{const e=t.properties.traffic_time_label;if(e)return e;const a=t.properties.traffic_time_minutes;if("number"===typeof a&&!isNaN(a)){const e=Math.floor(a/60),t=a%60;return e>0?`${e}h${t}m`:`${t}m`}return"N/A"})(),i=tr().divIcon({html:`\n                  <div style="transform: translate(-50%, -50%); background: ${e}; color: #fff; display: inline-block; padding: 2px 6px; font-weight: 700; line-height: 1; white-space: nowrap; border-radius: 8px; font-size: 12px;">\n                    ${r}\n                  </div>\n                  `,className:"route-center-point-icon",iconAnchor:[0,0],popupAnchor:[0,-10]}),l=tr().marker(a,{icon:i});return l}if(t.properties.routeOrder){const e=t.properties.routeOrder,r=t.properties.time_total||0,i=r/60,l=10*Math.PI*10,s=i*l,n=Math.sqrt(s/Math.PI),c=Math.max(2*n,20),d=12;console.log(`🎯 Service Point ${e}: time_total=${r}min (${i.toFixed(2)}h), area=${s.toFixed(1)}px², radius=${n.toFixed(1)}px, size=${c.toFixed(1)}px`);let u=`var(--my-color-${o})`;t.properties.fillColor?u=`var(--my-color-${t.properties.fillColor})`:t.properties.routeColor&&(u=`var(--my-color-${t.properties.routeColor})`);const p=tr().divIcon({html:`\n                  <div class="d-flex align-items-center justify-content-center fw-bold"\n                       style="background: ${u}; color: white; border-radius: 50%; width: ${c}px; height: ${c}px; font-size: ${d}px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">\n                    ${e}\n                  </div>\n                  `,className:"service-route-point-icon",iconSize:[c,c],iconAnchor:[c/2,c/2],popupAnchor:[0,-c/2]}),v=tr().marker(a,{icon:p});return v}{let e=`var(--my-color-${o})`;t.properties.fillColor?e=`var(--my-color-${t.properties.fillColor})`:t.properties.routeColor&&(e=`var(--my-color-${t.properties.routeColor})`);const r=tr().divIcon({html:`<div\n                  class="rounded-circle"\n                  style="\n                     background-color: ${e};\n                     width: 8px;\n                     height: 8px;\n                   ">\n                   </div>`,className:"",iconSize:[8,8],iconAnchor:[4,4],popupAnchor:[0,-4]});return tr().marker(a,{icon:r})}}return null},style:t=>{if(t.properties.layerName&&t.properties.layerName.includes("路線")){let e="var(--my-color-orange)";return t.properties.routeColor?e=`var(--my-color-${t.properties.routeColor})`:t.properties.strokeColor&&(e=`var(--my-color-${t.properties.strokeColor})`),{color:e,weight:t.properties.strokeWidth||3,opacity:t.properties.strokeOpacity||.8,lineCap:"round",lineJoin:"round",dashArray:null}}if(e.isRoutePlanningLayer&&"route-line"===t.properties.type){const e=t.properties.routeColor||t.properties.strokeColor||"orange";return{color:e.startsWith("--my-color-")?e:`var(--my-color-${e})`,weight:4,opacity:.8,lineCap:"round",lineJoin:"round",dashArray:null}}if(e.isRouteOptimizationLayer&&"optimized-route-line"===t.properties.type){const e=t.properties.routeColor||"purple";return{color:`var(--my-color-${e})`,weight:4,opacity:.8,lineCap:"round",lineJoin:"round",dashArray:null}}if("polygon"==e.type)return{fillColor:t.properties.fillColor,weight:1,opacity:1,color:t.properties.color||"white",fillOpacity:t.properties.fillColor?.6:0}},onEachFeature:(e,o)=>{if(o.isAnalysisLayer)o.bindPopup(`\n                <div class="">\n                  <div class="my-title-xs-gray pb-2">${r}</div>\n                  <div class="my-content-sm-black">${e.properties.name}</div>\n                </div>\n              `,{className:"analysis-popup",offset:[0,-5],closeButton:!0,autoClose:!1,closeOnClick:!1});else if(e.properties.layerName&&e.properties.layerName.includes("路線"))o.bindPopup(`\n                  <div class="">\n                    <div class="my-title-xs-gray pb-2">${e.properties.layerName}</div>\n                    <div class="my-content-sm-black">${e.properties.name}</div>\n                    <div class="my-content-xs-gray pt-1">服務人員: ${e.properties.serviceProviderId}</div>\n                    <div class="my-content-xs-gray">服務日期: ${a.selectedServiceDate||"無資料"}</div>\n                    <div class="my-content-xs-gray">服務點數: ${e.properties.pointCount} 個</div>\n                  </div>\n                `,{className:"service-route-popup",offset:[0,-5],closeButton:!0,autoClose:!1,closeOnClick:!1});else if(o.isRoutePlanningLayer)if("route-planning-point"===e.properties.type){const t="completed"===e.properties.status,a=t?`\n                  <div class="">\n                    <div class="my-title-xs-gray pb-2">${r}</div>\n                    <div class="my-content-sm-black">${e.properties.name}</div>\n                    <div class="my-content-xs-gray pt-1">順序: ${e.properties.order}</div>\n                    <div class="my-content-xs-gray">所屬路線: 路線 ${e.properties.routeNumber}</div>\n                    <div class="my-content-xs-gray">狀態: 已完成</div>\n                  </div>\n                `:`\n                  <div class="">\n                    <div class="my-title-xs-gray pb-2">${r}</div>\n                    <div class="my-content-sm-black">${e.properties.name}</div>\n                    <div class="my-content-xs-gray pt-1">順序: ${e.properties.order}</div>\n                    <div class="my-content-xs-gray">狀態: 規劃中</div>\n                  </div>\n                `;o.bindPopup(a,{className:"route-planning-popup "+(t?"completed":"active"),offset:[0,-5],closeButton:!0,autoClose:!1,closeOnClick:!1})}else"route-line"===e.properties.type&&o.bindPopup(`\n                  <div class="">\n                    <div class="my-title-xs-gray pb-2">${r}</div>\n                    <div class="my-content-sm-black">${e.properties.name}</div>\n                    <div class="my-content-xs-gray pt-1">總距離: ${e.properties.distance} km</div>\n                    <div class="my-content-xs-gray">預估時間: ${e.properties.duration} m</div>\n                    <div class="my-content-xs-gray">路徑點數: ${e.properties.waypoints}</div>\n                  </div>\n                `,{className:"route-planning-popup route-line-popup",offset:[0,-5],closeButton:!0,autoClose:!1,closeOnClick:!1});else if(e.properties.routeOrder&&e.properties.propertyData){const t=h(e.properties);o.bindPopup(t,{className:"service-point-popup",offset:[0,-5],closeButton:!0,autoClose:!0,closeOnClick:!0})}else o.bindPopup(`\n                  <div class="">\n                    <div class="my-title-xs-gray pb-2">${r}</div>\n                    <div class="my-content-sm-black">${e.properties.name}</div>\n                  </div>\n                `);o.on({click:function(){if((o.isAnalysisLayer||"analysis-layer"===e.properties.layerId)&&"point-analysis"===e.properties.type)return;if(e.properties.routeOrder&&e.properties.propertyData)return l.closePopup(),void(this.openPopup&&this.openPopup());if("route-center-point"===e.properties.type){a.setSelectedFeature(null),T();const t={type:"Feature",properties:{...e.properties,type:"route-center-point-selected"}};return void a.setSelectedFeature(t)}const r=s&&String(s).startsWith("service-provider-"),i=a.selectedFeature&&a.selectedFeature.properties&&a.selectedFeature.properties.id===e.properties.id;if(i)return console.log("🎯 MapTab: 點擊已選取的要素，清除選取"),a.setSelectedFeature(null),T(),void M();if(r||e.properties?.service_items&&Array.isArray(e.properties.service_items)&&e.properties.service_items.length>0){console.log("🎯 MapTab: 檢測到服務人員圖層點擊"),console.log("🎯 MapTab: feature.properties:",e.properties),console.log("🎯 MapTab: layer信息 (from store layer):",{layerId:s,layerName:n}),a.setSelectedFeature(null),T();const r=a.findLayerById(s)||a.findLayerById(e.properties.layerId)||{layerId:s,layerName:n};console.log("🎯 MapTab: storeLayer:",r),this._originalStyle={weight:this.options?.weight,color:this.options?.color,fillOpacity:this.options?.fillOpacity},this.bringToFront&&this.bringToFront();try{const{serviceItemsData:o}=a.createServiceItemsData(e,r);console.log("🎯 MapTab: 成功創建 serviceItemsData:",o),console.log("🎯 MapTab: serviceItems數量:",o.serviceItems?.length||0);const i={type:"Feature",properties:{...o.servicePoint,serviceItems:o.serviceItems,servicePointInfo:o.servicePointInfo,id:e.properties.id,type:"service-items",layerId:s,layerName:n}};console.log("🎯 MapTab: 創建 serviceItemsFeature:",i),a.setSelectedFeature(i),console.log("🎯 MapTab: 已設置 selectedFeature 到 dataStore"),t("show-service-point-detail",o),console.log("🎯 MapTab: 已發送 show-service-point-detail 事件"),console.log("🎯 MapTab: 服務點已選擇，不再縮放或顯示 popup")}catch(c){console.error("❌ MapTab: 創建服務項目資料時發生錯誤:",c);const t={type:"Feature",properties:{...e.properties,layerId:o.layerId,layerName:o.layerName}};a.setSelectedFeature(t)}}else a.setSelectedFeature(null),T(),a.setSelectedFeature(e),t("feature-selected",e)},contextmenu:function(t){!o.isAnalysisLayer&&"analysis-layer"!==e.properties.layerId||"circle-analysis"!==e.properties.type||F(t.originalEvent,e)}})}});return c},C=()=>{if(l){const e=l.getCenter(),t=l.getZoom();g={center:[e.lat,e.lng],zoom:t},console.log("🎯 保存當前視圖狀態:",g)}},S=()=>{l&&g&&(console.log("🎯 恢復之前的視圖狀態:",g),l.setView(g.center,g.zoom),r.setMapView(g.center,g.zoom),g=null)},T=()=>{console.log("🔄 MapTab: 重設所有圖層樣式"),l&&l.eachLayer((e=>{e.options&&e.options.icon&&("first-service-point-marker"===e.options.icon.options?.className||"highlight-service-point-marker"===e.options.icon.options?.className)&&l.removeLayer(e)})),Object.values(n).forEach((e=>{e&&e.eachLayer((t=>{const r=t.feature;if(r){const o=a.findLayerById(r.properties.layerId),i=o?.type;if(o?.isAnalysisLayer||"analysis-layer"===r.properties.layerId){if("point-analysis"===r.properties.type)return;"circle-analysis"===r.properties.type&&t._originalStyle&&t.setStyle(t._originalStyle)}else"point"===i||"polygon"===i&&(t._originalStyle?t.setStyle(t._originalStyle):e.resetStyle&&e.resetStyle(t));t.closePopup&&t.closePopup()}}))}))},P=()=>{if(!l||!m.value)return;const e=a.getAllLayers(),r=Object.keys(n),o=e.filter((e=>e.visible&&e.geoJsonData)),i=o.map((e=>e.layerId)),s=i.filter((e=>!r.includes(e))),c=r.filter((e=>!i.includes(e)));console.log(`🔄 圖層同步: 新增 ${s.length} 個, 移除 ${c.length} 個`),c.forEach((e=>{n[e]&&(l.removeLayer(n[e]),delete n[e],console.log(`🗺️ 移除圖層: ${e}`))}));const d=o.some((e=>e.isAnalysisLayer));d&&Object.keys(n).forEach((e=>{n[e]&&(l.removeLayer(n[e]),delete n[e])}));const u=[];if(o.slice().reverse().forEach((e=>{const{layerId:t}=e,a=d||!n[t];if(a)try{const a=x(e);a&&(e.isAnalysisLayer&&(a.isAnalysisLayer=!0),a.addTo(l),n[t]=a,s.includes(t)&&!e.isAnalysisLayer&&u.push(a),console.log(`🗺️ 圖層 "${e.layerName}" 已添加到地圖`))}catch(r){console.error(`添加圖層 "${e.layerName}" 時發生錯誤:`,r)}})),u.length>0){const e=new(tr().LatLngBounds);let t=!1;u.forEach((a=>{if(a&&a.getBounds){const r=a.getBounds();r.isValid()&&(e.extend(r),t=!0)}})),t&&setTimeout((()=>{l.fitBounds(e,{padding:[50,50]}),console.log(`🎯 自動縮放到新添加的 ${u.length} 個圖層範圍`)}),200)}const p=Object.values(n).reduce(((e,t)=>e+(t.getLayers?t.getLayers().length:0)),0);t("update:activeMarkers",p),console.log(`🗺️ 圖層同步完成，共 ${o.length} 個可見圖層`)},I=()=>{if(!l||!m.value||!f.value)return;const e=new(tr().LatLngBounds);let t=!1;Object.values(n).forEach((a=>{if(a&&a.getBounds){const r=a.getBounds();r.isValid()&&(e.extend(r),t=!0)}})),t&&l.fitBounds(e,{padding:[50,50]})},M=()=>{if(!l||!m.value)return;const e=[24.1477,120.6736],t=11;console.log(`🌍 顯示全市: 中心點 ${e}, 縮放等級 ${t}`),l.setView(e,t),r.setMapView(e,t)},D=e=>{if(console.log("🎯 MapTab: 開始高亮顯示要素:",e),!l||!m.value)return console.warn("⚠️ 地圖尚未準備就緒，延遲執行高亮顯示"),void setTimeout((()=>D(e)),200);if(!n||0===Object.keys(n).length)return console.warn("⚠️ 圖層群組尚未載入，延遲執行高亮顯示"),void setTimeout((()=>D(e)),200);let t,r;if("service-provider"===e.type){if(console.log("🎯 處理服務人員高亮事件:",e),e.firstServicePoint){const{lat:t,lon:r}=e.firstServicePoint;if(t&&r){l.setView([t,r],15),T();const a=tr().marker([t,r],{icon:tr().divIcon({className:"first-service-point-marker",html:'<div style="background-color: #ff6b6b; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">1</div>',iconSize:[20,20],iconAnchor:[10,10]})}).addTo(l);a.bindPopup(`\n                <div style="font-size: 14px;">\n                  <strong>第一個服務點</strong><br>\n                  姓名: ${e.firstServicePoint.name}<br>\n                  地址: ${e.firstServicePoint.address}<br>\n                  時間: ${e.firstServicePoint.time}\n                </div>\n              `).openPopup()}else console.log("⚠️ 第一個服務點沒有座標，無法在地圖上顯示");a.setSelectedFeature({type:"Feature",properties:{type:"service-provider",serviceProviderId:e.serviceProviderId,layerId:e.layerId,layerName:e.layerName,allServicePoints:e.allServicePoints,firstServicePoint:e.firstServicePoint}})}return void console.log("✅ 服務人員高亮事件處理完成，退出函數")}if("object"===typeof e&&null!==e&&null===e.id)return console.log("🎯 MapTab: 接收到清除高亮事件"),T(),void M();if("service-item-highlight"===e.type){console.log("🎯 MapTab: 處理服務項目高亮事件:",e),T(),l.closePopup();const t=e.coordinates,r=t?.lat,o=t?.lon;if(r&&o){console.log("🎯 MapTab: 移動地圖到座標:",r,o),C(),l.setView([r,o],16);let t=!1;const i=n[e.layerId];if(i&&(console.log("🎯 MapTab: 在圖層中尋找對應的服務點"),i.eachLayer((a=>{if(t)return;const i=a.feature;if(i&&i.properties&&i.geometry){const l=i.geometry.coordinates[1],s=i.geometry.coordinates[0];if(Math.abs(l-r)<1e-4&&Math.abs(s-o)<1e-4){console.log("✅ 找到匹配的服務點，添加 popup");const r=e.item||{},o=h(r);a.bindPopup&&(a.bindPopup(o,{closeButton:!0,autoClose:!0,closeOnClick:!0,className:"service-point-popup",opacity:.9}),a.openPopup&&a.openPopup()),t=!0,console.log("✅ popup 添加完成")}}}))),!t){console.log("⚠️ 沒有找到現有服務點，創建臨時 popup");const t=e.item,a=tr().marker([r,o],{opacity:0,icon:tr().divIcon({className:"temp-popup-marker",html:"",iconSize:[1,1],iconAnchor:[0,0]})}).addTo(l),i=t,s=h(i);a.bindPopup(s,{closeButton:!0,autoClose:!0,closeOnClick:!0,className:"service-point-popup",opacity:.9}).openPopup()}setTimeout((()=>{a.selectedFeature||(S(),l.eachLayer((e=>{e.options&&e.options.icon&&("temp-popup-marker"===e.options.icon.options.className||"highlight-service-point-marker"===e.options.icon.options.className)&&l.removeLayer(e)})))}),1500)}else console.warn("⚠️ MapTab: 服務項目沒有有效的座標信息");return}"object"===typeof e&&null!==e?(t=e.layerId,r=e.id):r=e,console.log(`🔍 尋找要素: layerId="${t}", featureId="${r}"`),console.log("🔍 可用的圖層群組:",Object.keys(n));const o=()=>{T();let e=null,o=null;if(t&&n[t]){console.log(`🔍 在指定圖層 "${t}" 中尋找要素`);const a=n[t];a.eachLayer((a=>{const i=a.feature;if(i&&i.properties){const l=i.properties.id||i.properties["#"]||i.properties.編號;if(console.log(`🔍 檢查要素 ID: ${l} (目標: ${r})`),String(l)===String(r))return e=a,o=i,void console.log(`✅ 在圖層 "${t}" 中找到要素 "${r}"`)}}))}else{console.log("🔍 在所有圖層中尋找要素");for(const[a,i]of Object.entries(n))if(console.log(`🔍 檢查圖層: ${a}`),i.eachLayer((i=>{const l=i.feature;if(l&&l.properties){const s=l.properties.id||l.properties["#"]||l.properties.編號;if(console.log(`🔍 檢查要素 ID: ${s} (目標: ${r})`),String(s)===String(r))return e=i,o=l,t=a,void console.log(`✅ 在圖層 "${a}" 中找到要素 "${r}"`)}})),e)break}if(e&&o){if("Point"===e.feature?.geometry?.type){const t=e.getElement();if(t){const e=t.querySelector("div");e&&(e.style.transition="transform 0.04s ease-in-out",e.style.transform="scale(1.6)"),t.style.zIndex=1e3}}else e.setStyle&&(e.feature?.properties?.fillColor?e.setStyle({weight:4,color:"white",fillOpacity:.8}):e.setStyle({weight:4}));let t;if(e.bringToFront&&e.bringToFront(),e.getBounds)t=e.getBounds();else if(e.getLatLng){const a=e.getLatLng();t=tr().latLngBounds([a,a])}return t&&t.isValid()&&(C(),l.fitBounds(t,{maxZoom:16,padding:[50,50]}),setTimeout((()=>{e.openPopup&&e.openPopup();const t=e.feature,a=t&&t.properties&&(t.properties.編號||t.properties.name);if(a&&e.getLatLng){const a=t.properties,r=h(a);e.bindPopup(r,{closeButton:!0,autoClose:!0,closeOnClick:!0,className:"service-point-popup",opacity:.9}),e.openPopup()}}),500),setTimeout((()=>{a.selectedFeature||(T(),S())}),1500)),console.log("✅ 顯示位置功能完成"),!0}return console.warn(`❌ 找不到要素 "${r}"${t?` 在圖層 "${t}" 中`:""}`),!1},i=o();i||(console.log("🔄 第一次高亮顯示失敗，1秒後重試..."),setTimeout((()=>{const e=o();e||console.error("❌ 重試後仍無法高亮顯示要素")}),1e3))},E=()=>{l&&m.value?(0,i.dY)((()=>{try{if(o.value){const e=o.value.getBoundingClientRect();if(0===e.width||0===e.height)return console.warn("🔄 地圖容器尺寸為零，延遲刷新地圖尺寸"),void setTimeout((()=>{if(o.value&&l&&m.value){const e=o.value.getBoundingClientRect();e.width>0&&e.height>0&&(l.invalidateSize(),console.log("🗺️ 地圖尺寸已延遲刷新"))}}),100)}l.invalidateSize(),console.log("🗺️ 地圖尺寸已刷新")}catch(e){console.error("❌ 刷新地圖尺寸時發生錯誤:",e)}})):l||console.warn("🔄 地圖實例不存在，等待初始化完成")},$=()=>{a.clearAnalysisLayer(),console.log("🗑️ 清除分析圖層")},F=(e,t)=>{e.preventDefault(),e.stopPropagation(),v.value=t,p.value={x:e.pageX||e.clientX,y:e.pageY||e.clientY},u.value=!0,console.log("🖱️ 顯示分析要素右鍵菜單:",t.properties.name)},z=()=>{if(!v.value)return;const e=v.value,t=e.properties.layerId;let r;r="circle-analysis"===e.properties.type?e.properties.id:e.properties.parentId,r&&("analysis-layer"===t&&(a.deleteAnalysisPoint(r),console.log("🗑️ 刪除分析點:",r)),N())},N=()=>{u.value=!1,v.value=null};let V=null,A=null;const R=()=>{o.value&&window.ResizeObserver&&(V=new ResizeObserver((e=>{for(let t of e)console.log("🔄 地圖容器大小變化:",t.contentRect),A&&clearTimeout(A),A=setTimeout((()=>{l&&m.value&&E(),A=null}),150)})),V.observe(o.value),console.log("✅ ResizeObserver 已設置"))},W=e=>{r.setSelectedBasemap(e),k()},X=e=>{const t=r.basemaps.find((t=>t.value===e));return t?t.label:e};let B=!1,K=null;const O=()=>{if(console.log("[MapTab] initMap 被調用，當前狀態:",{mapInstance:!!l,isMapReady:m.value,isInitializing:B,containerExists:!!o.value}),l&&m.value)return void console.warn("[MapTab] 地圖已初始化，跳過重複初始化");if(B)return void console.warn("[MapTab] 地圖正在初始化中，跳過重複初始化");K&&(clearTimeout(K),K=null),console.log("[MapTab] 開始初始化地圖"),B=!0;let e=0;const t=20,a=()=>{if(!o.value)return console.warn(`[MapTab] 嘗試 ${e}: 地圖容器不存在`),!1;const t=o.value.getBoundingClientRect(),a=window.getComputedStyle(o.value);if(console.log(`[MapTab] 嘗試 ${e}: 容器狀態`,{width:t.width,height:t.height,display:a.display,visibility:a.visibility,parentElement:o.value.parentElement?.tagName,parentRect:o.value.parentElement?.getBoundingClientRect()}),0===t.width||0===t.height)return console.warn(`[MapTab] 嘗試 ${e}: 容器尺寸為零`),!1;if("none"===a.display||"hidden"===a.visibility)return console.warn(`[MapTab] 嘗試 ${e}: 容器隱藏`),!1;let r=o.value.parentElement;while(r){const t=window.getComputedStyle(r);if("none"===t.display||"hidden"===t.visibility)return console.warn(`[MapTab] 嘗試 ${e}: 父元素隱藏`,r.tagName),!1;r=r.parentElement}return!0},r=()=>{if(e>=t)return console.error("[MapTab] 地圖初始化超時，已達最大嘗試次數",t),void(B=!1);if(e++,!a()){const a=Math.min(200*e,1e3);return console.log(`[MapTab] 容器未準備就緒，${a}ms 後重試 (${e}/${t})`),void setTimeout(r,a)}try{console.log(`[MapTab] 容器準備就緒，嘗試創建地圖 (${e}/${t})`),b()?(console.log("[MapTab] 地圖創建成功，設定底圖和同步圖層"),k(),P(),B=!1,console.log("[MapTab] 地圖初始化完成")):(console.warn("[MapTab] 地圖創建失敗，繼續重試"),setTimeout(r,200))}catch(o){console.error("[MapTab] 地圖創建過程中發生錯誤:",o),e<t?setTimeout(r,200):(console.error("[MapTab] 重試次數已達上限，初始化失敗"),B=!1)}};r(),K=setTimeout((()=>{B&&(console.error("[MapTab] 地圖初始化總體超時 (30秒)，強制終止"),B=!1)}),3e4)};return(0,i.sV)((()=>{console.log("[MapTab] 組件已掛載，開始初始化流程"),(0,i.dY)((()=>{setTimeout((()=>{console.log("[MapTab] DOM 更新完成，開始地圖初始化"),O(),setTimeout((()=>{m.value?R():console.warn("[MapTab] 地圖尚未準備就緒，跳過 ResizeObserver 設置")}),500)}),100)})),document.addEventListener("click",N)})),(0,i.hi)((()=>{console.log("[MapTab] 組件卸載，清理資源"),K&&(clearTimeout(K),K=null,console.log("🧹 初始化超時計時器已清理")),B&&(console.warn("[MapTab] 組件卸載時初始化仍在進行中"),B=!1),A&&(clearTimeout(A),A=null),V&&(V.disconnect(),V=null,console.log("🧹 ResizeObserver 已清理")),l&&(l.off("zoomend",L),l.off("moveend",w),l.remove(),l=null,console.log("🧹 地圖實例已清理")),n={},s=null,m.value=!1,document.removeEventListener("click",N),console.log("[MapTab] 資源清理完成")})),(0,i.wB)((()=>a.layers),P,{deep:!0}),(0,i.wB)((()=>r.selectedBasemap),(()=>{m.value&&k()})),(0,i.wB)((()=>a.selectedFeature),((e,t)=>{console.log("🎯 MapTab: selectedFeature 變化",{newFeature:e,oldFeature:t}),e&&(console.log("🎯 MapTab: 新的選擇，確保只有一個物件被高亮顯示"),e.properties),t&&!e&&(console.log("🎯 MapTab: 清除選取，恢復預設視圖"),T(),"Point"===t.geometry?.type||"service-items"===t.properties?.type||t.properties?.layerId?.startsWith("service-provider-")?M():S())}),{deep:!0}),{mapContainer:o,mapContainerId:y,selectedBasemap:(0,i.EW)((()=>r.selectedBasemap)),changeBasemap:W,getBasemapLabel:X,showAllFeatures:I,showFullCity:M,isAnyLayerVisible:f,highlightFeature:D,invalidateSize:E,clearAnalysisLayer:$,mapStore:r,contextMenu:d,showContextMenu:u,contextMenuPosition:p,selectedAnalysisFeature:v,deleteAnalysisPoint:z,hideContextMenu:N,selectedServiceDate:(0,i.EW)((()=>a.selectedServiceDate))}}};const sr=(0,u.A)(lr,[["render",Za],["__scopeId","data-v-5781ec08"]]);var nr=sr,cr=a(9224);const dr={class:"d-flex flex-column my-bgcolor-gray-200 h-100"},ur={key:0,class:""},pr={class:"nav nav-tabs nav-fill"},vr=["onClick"],mr={class:"my-title-sm-black"},yr={key:1,class:"flex-grow-1 overflow-auto my-bgcolor-white p-3"},gr={class:"mb-4"},hr={class:"my-title-md-black"},fr={key:0},br={class:"row"},Lr={class:"col-12 col-xl-6"},wr={class:"rounded-4 my-bgcolor-gray-100 p-4 mb-3"},kr={class:"row"},xr={class:"col-6"},Cr={class:"text-center"},_r={class:"my-title-xl-black"},Sr={key:0,class:"col-6"},Tr={class:"text-center"},Pr={class:"my-title-xl-black"},Ir={key:0,class:"col-12 col-xl-6"},Mr={class:"rounded-4 my-bgcolor-gray-100 p-4 mb-3"},Dr={key:1,class:"text-center py-5"},Er={key:2,class:"flex-grow-1 d-flex align-items-center justify-content-center"};var $r={__name:"DashboardTab",setup(e){const t=_(),a=(0,c.KR)(null),r=(0,c.KR)(null),o=(0,i.EW)((()=>{const e=t.getAllLayers();return e.filter((e=>e.visible))})),l=e=>{a.value=e},s=(0,i.EW)((()=>{if(!a.value)return null;const e=o.value.find((e=>e.layerId===a.value));return e&&e.summaryData||null})),n=(0,i.EW)((()=>{if(!a.value)return"無開啟圖層";const e=o.value.find((e=>e.layerId===a.value));return e?e.layerName||"未知圖層":"無開啟圖層"})),d=e=>{if(!r.value||!e||0===e.length)return;const t=e.filter((e=>e&&"number"===typeof e.count&&e.count>=0&&e.name&&"string"===typeof e.name));if(0===t.length)return void console.warn("[DashboardTab] 沒有有效的行政區資料可以繪製圖表");cr.Ltv(r.value).selectAll("*").remove();const a={top:0,right:48,bottom:16,left:48},o=r.value.clientWidth,i=o-a.left-a.right,l=8,s=24,n=t.length*s;if(i<=0)return void console.warn("[DashboardTab] 圖表容器寬度無效，跳過繪製");const c=cr.Ltv(r.value).append("svg").attr("width",o).attr("height",n+a.top+a.bottom),d=c.append("g").attr("transform",`translate(${a.left},${a.top})`),u=cr.T9B(t,(e=>e.count));if(!u||u<=0)return void console.warn("[DashboardTab] 最大計數值無效，跳過繪製");const p=cr.m4Y().domain([0,u]).range([0,i]),v=e=>{let t;const a=5,r=Math.ceil(e/(a-1));t=r<=5?5:r<=10?10:r<=20?20:r<=50?50:r<=100?100:5*Math.ceil(r/5);const o=Math.ceil(e/t)*t,i=[];for(let l=0;l<=o&&i.length<a;l+=t)i.push(l);return{ticks:i,maxValue:o,interval:t}},m=v(u),y=m.ticks;p.domain([0,m.maxValue]),d.selectAll(".grid-line").data(y).enter().append("line").attr("class","grid-line").attr("x1",(e=>p(e))).attr("x2",(e=>p(e))).attr("y1",0).attr("y2",n).attr("stroke","var(--my-color-gray-400)").attr("stroke-dasharray","2,2").attr("stroke-width",1),d.selectAll(".bar").data(t).enter().append("rect").attr("class","bar").attr("x",0).attr("y",((e,t)=>t*s+(s-l)/2)).attr("width",(e=>Math.max(0,p(e.count)))).attr("height",l).attr("fill","var(--my-color-blue)"),d.selectAll(".label").data(t).enter().append("text").attr("class","label my-font-size-xs").attr("x",(e=>Math.max(0,p(e.count))+5)).attr("y",((e,t)=>t*s+s/2)).attr("dy","0.35em").attr("fill","var(--my-color-black)").text((e=>e.count)),d.selectAll(".district-label").data(t).enter().append("text").attr("class","district-label my-font-size-xs").attr("x",-5).attr("y",((e,t)=>t*s+s/2)).attr("dy","0.35em").attr("fill","var(--my-color-black)").style("text-anchor","end").text((e=>e.name)),d.selectAll(".x-axis-label").data(y).enter().append("text").attr("class","x-axis-label my-font-size-xs").attr("x",(e=>p(e))).attr("y",n+15).attr("fill","var(--my-color-gray-600)").style("text-anchor","middle").text((e=>e))},u=(0,c.KR)([]);(0,i.wB)((()=>o.value),(e=>{if(0===e.length)return a.value=null,void(u.value=[]);const t=u.value.map((e=>e.layerId)),r=e.map((e=>e.layerId)),o=r.filter((e=>!t.includes(e)));if(o.length>0){const t=o[o.length-1];a.value=t,console.log(`🔄 自動切換到新開啟的圖層: ${e.find((e=>e.layerId===t))?.layerName}`)}else a.value&&e.find((e=>e.layerId===a.value))||(a.value=e[0].layerId);u.value=[...e]}),{deep:!0,immediate:!0}),(0,i.wB)((()=>s.value),(e=>{e&&e.districtCount&&(0,i.dY)((()=>{d(e.districtCount)}))}),{immediate:!0}),(0,i.sV)((()=>{console.log("[DashboardTab] Component Mounted"),o.value.length>0&&!a.value&&(a.value=o.value[0].layerId)}));const p=()=>{s.value&&s.value.districtCount&&(0,i.dY)((()=>{d(s.value.districtCount)}))};return(0,i.sV)((()=>{window.addEventListener("resize",p)})),(0,i.hi)((()=>{window.removeEventListener("resize",p)})),(e,t)=>((0,i.uX)(),(0,i.CE)("div",dr,[o.value.length>0?((0,i.uX)(),(0,i.CE)("div",ur,[(0,i.Lk)("ul",pr,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(o.value,(e=>((0,i.uX)(),(0,i.CE)("li",{key:e.layerId,class:"nav-item d-flex flex-column align-items-center"},[(0,i.Lk)("div",{class:(0,y.C4)(["btn nav-link rounded-0 border-0 position-relative d-flex align-items-center justify-content-center my-bgcolor-gray-200",{active:a.value===e.layerId}]),onClick:t=>l(e.layerId)},[(0,i.Lk)("span",mr,(0,y.v_)(e.layerName),1)],10,vr),(0,i.Lk)("div",{class:(0,y.C4)(["w-100",`my-bgcolor-${e.colorName}`]),style:{"min-height":"4px"}},null,2)])))),128))])])):(0,i.Q3)("",!0),o.value.length>0?((0,i.uX)(),(0,i.CE)("div",yr,[(0,i.Lk)("div",gr,[(0,i.Lk)("h5",hr,(0,y.v_)(n.value),1)]),s.value?((0,i.uX)(),(0,i.CE)("div",fr,[(0,i.Lk)("div",br,[(0,i.Lk)("div",Lr,[(0,i.Lk)("div",wr,[t[2]||(t[2]=(0,i.Lk)("h6",{class:"mb-3"},"基本統計",-1)),(0,i.Lk)("div",kr,[(0,i.Lk)("div",xr,[(0,i.Lk)("div",Cr,[(0,i.Lk)("div",_r,(0,y.v_)(s.value.totalCount),1),t[0]||(t[0]=(0,i.Lk)("div",{class:"my-title-sm-gray"},"總數量",-1))])]),s.value.districtCount?((0,i.uX)(),(0,i.CE)("div",Sr,[(0,i.Lk)("div",Tr,[(0,i.Lk)("div",Pr,(0,y.v_)(s.value.districtCount.length),1),t[1]||(t[1]=(0,i.Lk)("div",{class:"my-title-sm-gray"},"行政區數量",-1))])])):(0,i.Q3)("",!0)])])]),s.value.districtCount&&s.value.districtCount.length>0?((0,i.uX)(),(0,i.CE)("div",Ir,[(0,i.Lk)("div",Mr,[t[3]||(t[3]=(0,i.Lk)("h6",{class:"mb-3"},"行政區分布",-1)),(0,i.Lk)("div",{ref_key:"chartContainer",ref:r,class:"w-100"},null,512)])])):(0,i.Q3)("",!0)])])):((0,i.uX)(),(0,i.CE)("div",Dr,t[4]||(t[4]=[(0,i.Lk)("div",{class:"my-title-md-gray"},"此圖層沒有可用的摘要資訊",-1)])))])):((0,i.uX)(),(0,i.CE)("div",Er,t[5]||(t[5]=[(0,i.Lk)("div",{class:"text-center"},[(0,i.Lk)("div",{class:"my-title-md-gray p-3"},"沒有開啟的圖層")],-1)])))]))}};const Fr=$r;var zr=Fr,Nr={name:"UpperView",components:{MapTab:nr,DashboardTab:zr},props:{activeUpperTab:{type:String,default:"map"},mainPanelWidth:{type:Number,default:60},contentHeight:{type:Number,default:500},showTainanLayer:{type:Boolean,default:!1},selectedFilter:{type:String,default:""},zoomLevel:{type:Number,default:11},isPanelDragging:{type:Boolean,default:!1},activeMarkers:{type:Number,default:0}},emits:["update:activeUpperTab","update:zoomLevel","update:currentCoords","update:activeMarkers","show-service-point-detail"],setup(e,{emit:t}){const a=(0,c.KR)(null),r=(0,c.KR)(null),o=(0,c.KR)(null);(0,i.wB)([()=>e.isPanelDragging,()=>e.activeUpperTab],(([e,t])=>{(0,i.dY)((()=>{o.value&&(e&&"dashboard"===t?(o.value.style.pointerEvents="none",console.log("MainContent: Dashboard container pointer-events set to none")):(o.value.style.pointerEvents="auto",console.log("MainContent: Dashboard container pointer-events set to auto (dragging:",e,", tab:",t,")")))}))}),{immediate:!0}),(0,i.wB)((()=>e.activeUpperTab),((t,r)=>{console.log("🔄 UpperView: Tab changed from",r,"to",t),"map"===t&&r&&"map"!==r&&(0,i.dY)((()=>{a.value&&(console.log("🗺️ UpperView: Refreshing map size after showing map tab"),setTimeout((()=>{a.value&&"map"===e.activeUpperTab&&(a.value.invalidateSize(),console.log("🗺️ UpperView: Map size refreshed successfully"))}),100))}))})),(0,i.wB)([()=>e.mainPanelWidth,()=>e.contentHeight],(()=>{(0,i.dY)((()=>{"map"===e.activeUpperTab&&a.value&&(a.value.invalidateSize(),setTimeout((()=>{a.value&&(a.value.invalidateSize(),console.log("🗺️ UpperView: Extra map size invalidation for responsive layout"))}),200))}))}));const l=r=>{console.log("🎯 UpperView: highlightFeature called with data:",r),"map"!==e.activeUpperTab?(t("update:activeUpperTab","map"),(0,i.dY)((()=>{a.value?.highlightFeature(r)}))):a.value?.highlightFeature(r)},s=()=>{"map"===e.activeUpperTab&&a.value&&a.value.resetView()},n=()=>{"map"===e.activeUpperTab&&a.value&&a.value.fitToTainanBounds()},d=()=>{"map"===e.activeUpperTab&&a.value&&a.value.invalidateSize()},u=()=>{"map"===e.activeUpperTab&&a.value&&a.value.retryMapInitialization()},p=()=>"map"===e.activeUpperTab&&a.value?a.value.mapInitStatus:"not-applicable";return{MapTab:a,DashboardTab:r,dashboardContainerRef:o,highlightFeature:l,resetView:s,fitToTainanBounds:n,invalidateMapSize:d,retryMapInitialization:u,getMapInitStatus:p}}};const Vr=(0,u.A)(Nr,[["render",Oa]]);var Ar=Vr;const Rr={ref:"bottomTabContentRef",class:"flex-grow-1 h-100 overflow-auto"},Wr={class:"h-100"};function Xr(e,t,a,r,o,l){const s=(0,i.g2)("DataTableTab");return(0,i.uX)(),(0,i.CE)("div",{class:"d-flex flex-column",style:(0,y.Tr)({height:a.bottomViewHeight+"px"})},[(0,i.Lk)("div",Rr,[(0,i.Lk)("div",Wr,[(0,i.bF)(s,{onHighlightOnMap:t[0]||(t[0]=t=>e.$emit("highlight-on-map",t)),onShowServicePointDetail:t[1]||(t[1]=t=>e.$emit("show-service-point-detail",t))})])],512)],4)}const Br={class:"d-flex flex-column my-bgcolor-gray-200 h-100"},Kr={key:0,class:""},Or={class:"nav nav-tabs nav-fill"},Hr=["onClick"],Ur={class:"my-title-sm-black"},jr={key:0,class:"my-content-xs-gray ms-2"},Jr={key:1,class:"flex-grow-1 overflow-hidden"},Qr={class:"h-100 d-flex flex-column"},Gr={class:"flex-grow-1 overflow-auto"},Yr={class:"table w-100 mb-0"},qr={class:"sticky-top my-table-thead"},Zr={class:"text-center text-nowrap"},eo=["onClick"],to={class:"my-title-xs-gray text-nowrap"},ao={class:"my-title-xs-gray text-nowrap ms-2"},ro=["onClick"],oo={key:0,class:"border-0 text-nowrap text-truncate p-0",style:{"max-width":"80px"}},io={key:0,class:"d-flex p-0"},lo={class:"my-content-xs-black w-100 px-3 py-2"},so={key:1,class:"my-content-xs-black px-3 py-2"},no=["innerHTML"],co={key:1},uo={key:2,class:"flex-grow-1 d-flex align-items-center justify-content-center"};var po={__name:"DataTableTab",emits:["highlight-on-map","show-service-point-detail"],setup(e,{emit:t}){const a=t,o=_(),l=(0,c.KR)(null),s=(0,c.KR)({}),n=(0,i.EW)((()=>{const e=o.getAllLayers();return e.filter((e=>e.visible))})),d=e=>{l.value=e},u=e=>{const t=e.layerId&&(e.layerId.startsWith("service-provider-")||e.layerId.startsWith("service-date-"));if(t)return["#","編號","姓名","個案居住地址","服務時間","總時間","交通時間","服務數量"];const a=v(e);if(!a||0===a.length)return[];const r=a[0];return Object.keys(r).filter((e=>{const t=r[e];return"object"!==typeof t||null===t}))},p=e=>e.tableData?.length||0,v=e=>{if(console.log("🔍 getSortedData 被調用:",e.layerId,e.tableData),!e.tableData)return console.log("⚠️ 沒有 tableData"),[];const t=s.value[e.layerId];return t&&t.key?[...e.tableData].sort(((e,a)=>{const r=e[t.key],o=a[t.key];return"string"===typeof r&&"string"===typeof o?"asc"===t.order?r.localeCompare(o):o.localeCompare(r):"asc"===t.order?r-o:o-r})):(console.log("📊 返回原始 tableData:",e.tableData.length,"筆資料"),e.tableData)},m=(e,t)=>{s.value[e]||(s.value[e]={key:null,order:"asc"});const a=s.value[e];a.key===t?a.order="asc"===a.order?"desc":"asc":(a.key=t,a.order="asc")},g=(e,t)=>{const a=s.value[e];return a&&a.key===t?"asc"===a.order?"fas fa-sort-up":"fas fa-sort-down":"fas fa-sort"},h=e=>{if(e.layerId&&(e.layerId.startsWith("service-provider-")||e.layerId.startsWith("service-date-"))&&e.geoJsonData){const t=e.geoJsonData.features||[];if(t.length>0){const e=t[0];if(e.properties){if(e.properties.fillColor)return`var(--my-color-${e.properties.fillColor})`;if(e.properties.routeColor)return`var(--my-color-${e.properties.routeColor})`}}}return e.colorName?`var(--my-color-${e.colorName})`:"var(--my-color-gray-300)"},f=(e,t,a,r=0)=>{const o=a.layerId&&(a.layerId.startsWith("service-provider-")||a.layerId.startsWith("service-date-"));if(o)switch(t){case"#":return e["#"]||(r+1).toString();case"編號":return e.編號||"N/A";case"姓名":{const t=e.姓名||"N/A",a=e.性別||"",r="男性"===a?"my-color-blue":"女性"===a?"my-color-red":"",o="男性"===a?"M":"女性"===a?"F":"";return`<span class="${r}">${t}${o?` (${o})`:""}</span>`}case"個案居住地址":return e.個案居住地址||"N/A";case"服務時間":{const t=(()=>e.時間?e.時間:e.起始時間?e.起始時間:void 0!==e.hour_start&&void 0!==e.min_start?`${e.hour_start}:${String(e.min_start).padStart(2,"0")}`:"N/A")(),a=(()=>e.結束時間?e.結束時間:void 0!==e.hour_end&&void 0!==e.min_end?`${e.hour_end}:${String(e.min_end).padStart(2,"0")}`:"N/A")();return`${t} - ${a}`}case"總時間":if(e.總時間)return e.總時間;if(void 0!==e.hour_start&&void 0!==e.min_start&&void 0!==e.hour_end&&void 0!==e.min_end){const t=60*e.hour_start+e.min_start,a=60*e.hour_end+e.min_end,r=a-t;if(r>0){const e=Math.floor(r/60),t=r%60;return e>0?`${e}h${t}m`:`${t}m`}}return"N/A";case"交通時間":if(e.交通時間)return e.交通時間;if(void 0!==e.hour_traffic&&void 0!==e.min_traffic){const t=e.hour_traffic||0,a=e.min_traffic||0;if(t>0||a>0)return t>0?`${t}h${a}m`:`${a}m`}return"0m";case"服務數量":return(e.service_items_count??(Array.isArray(e.service_items)?e.service_items.length:null)??e.服務數量??0).toString();default:return e[t]||"N/A"}return e[t]||"N/A"},b=(e,t,r=0)=>{console.log("🎯 DataTableTab: 準備高亮顯示:",{item:e,layer:t.layerName});const i=e.id||e["#"]||e.編號,l=o.selectedFeature&&o.selectedFeature.properties&&o.selectedFeature.properties.id===i;if(l){console.log("🎯 DataTableTab: 點擊已選取的要素，清除選取"),o.setSelectedFeature(null);const e={id:null,layerId:t.layerId,layerName:t.layerName};return void setTimeout((()=>{a("highlight-on-map",e)}),50)}const s=t.layerId&&(t.layerId.startsWith("service-provider-")||t.layerId.startsWith("service-date-"));if(s){console.log("🎯 DataTableTab: 處理服務人員圖層點擊:",e),o.setSelectedFeature(null);const{serviceItemsData:i}=o.createServiceItemsData(e,t);console.log("🎯 DataTableTab: 創建的服務項目資料:",i),a("show-service-point-detail",i);const l={type:"service-item-highlight",layerId:t.layerId,layerName:t.layerName,item:e,rowIndex:r,serviceProviderId:t.serviceProviderId,serviceDate:t.serviceDate,coordinates:{lat:e.緯度||e.lat,lon:e.經度||e.lon}};console.log("🎯 DataTableTab: 發送服務項目高亮事件:",l),setTimeout((()=>{a("highlight-on-map",l)}),100)}else{const r={id:e.id||e["#"]||e.編號,layerId:t.layerId,layerName:t.layerName,item:e};console.log("🎯 DataTableTab: 發送一般高亮事件:",r),setTimeout((()=>{a("highlight-on-map",r)}),50)}},L=(0,c.KR)([]);return(0,i.wB)((()=>n.value),(e=>{if(0===e.length)return l.value=null,void(L.value=[]);const t=L.value.map((e=>e.layerId)),a=e.map((e=>e.layerId)),r=a.filter((e=>!t.includes(e)));if(r.length>0){const t=r[r.length-1];l.value=t,console.log(`🔄 自動切換到新開啟的圖層: ${e.find((e=>e.layerId===t))?.layerName}`)}else l.value&&e.find((e=>e.layerId===l.value))||(l.value=e[0].layerId);L.value=[...e]}),{deep:!0,immediate:!0}),(0,i.sV)((()=>{console.log("[MultiLayerDataTableTab] Component Mounted"),n.value.length>0&&!l.value&&(l.value=n.value[0].layerId)})),(e,t)=>((0,i.uX)(),(0,i.CE)("div",Br,[n.value.length>0?((0,i.uX)(),(0,i.CE)("div",Kr,[(0,i.Lk)("ul",Or,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(n.value,(e=>((0,i.uX)(),(0,i.CE)("li",{key:e.layerId,class:"nav-item d-flex flex-column align-items-center"},[(0,i.Lk)("div",{class:(0,y.C4)(["btn nav-link rounded-0 border-0 position-relative d-flex align-items-center justify-content-center my-bgcolor-gray-200",{active:l.value===e.layerId}]),onClick:t=>d(e.layerId)},[(0,i.Lk)("span",Ur,[(0,i.eW)((0,y.v_)(e.layerName)+" ",1),p(e)?((0,i.uX)(),(0,i.CE)("span",jr,(0,y.v_)(p(e)),1)):(0,i.Q3)("",!0)])],10,Hr),(0,i.Lk)("div",{class:"w-100",style:(0,y.Tr)({backgroundColor:h(e),minHeight:"4px"})},null,4)])))),128))])])):(0,i.Q3)("",!0),n.value.length>0?((0,i.uX)(),(0,i.CE)("div",Jr,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(n.value,(e=>(0,i.bo)(((0,i.uX)(),(0,i.CE)("div",{key:e.layerId,class:"h-100"},[(0,i.Lk)("div",Qr,[(0,i.Lk)("div",Gr,[(0,i.Lk)("table",Yr,[(0,i.Lk)("thead",qr,[(0,i.Lk)("tr",Zr,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(u(e),(t=>((0,i.uX)(),(0,i.CE)(i.FK,{key:t},["color"!==t?((0,i.uX)(),(0,i.CE)("th",{key:0,onClick:a=>m(e.layerId,t),class:"my-bgcolor-white-hover p-1 my-cursor-pointer"},[(0,i.Lk)("span",to,(0,y.v_)(t),1),(0,i.Lk)("span",ao,[(0,i.Lk)("i",{class:(0,y.C4)(g(e.layerId,t))},null,2)])],8,eo)):(0,i.Q3)("",!0)],64)))),128))])]),(0,i.Lk)("tbody",null,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(v(e),((t,a)=>((0,i.uX)(),(0,i.CE)("tr",{key:t.id,class:"my-table-tr-hover text-center text-nowrap border-bottom my-cursor-pointer",onClick:()=>{console.log("🔥 表格行被點擊了!",t,e,a),b(t,e,a)}},[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(u(e),(r=>((0,i.uX)(),(0,i.CE)(i.FK,{key:r},["color"!==r?((0,i.uX)(),(0,i.CE)("td",oo,["#"===r?((0,i.uX)(),(0,i.CE)("div",io,[(0,i.Lk)("div",{style:(0,y.Tr)([{"min-width":"6px"},{backgroundColor:h(e)}])},null,4),(0,i.Lk)("div",lo,(0,y.v_)(f(t,r,e,a)),1)])):((0,i.uX)(),(0,i.CE)("div",so,["交通時間"===r&&(e.layerId.startsWith("service-provider-")||e.layerId.startsWith("service-date-"))&&0===a?((0,i.uX)(),(0,i.CE)(i.FK,{key:0},[(0,i.eW)("-")],64)):((0,i.uX)(),(0,i.CE)(i.FK,{key:1},["姓名"===r?((0,i.uX)(),(0,i.CE)("span",{key:0,innerHTML:f(t,r,e,a)},null,8,no)):((0,i.uX)(),(0,i.CE)("span",co,(0,y.v_)(f(t,r,e,a)),1))],64))]))])):(0,i.Q3)("",!0)],64)))),128))],8,ro)))),128))])])])])])),[[r.aG,l.value===e.layerId]]))),128))])):((0,i.uX)(),(0,i.CE)("div",uo,t[0]||(t[0]=[(0,i.Lk)("div",{class:"text-center"},[(0,i.Lk)("div",{class:"my-title-md-gray p-3"},"沒有開啟的圖層")],-1)])))]))}};const vo=(0,u.A)(po,[["__scopeId","data-v-5802bfdc"]]);var mo=vo,yo={name:"BottomView",components:{DataTableTab:mo},props:{activeBottomTab:{type:String,default:"table"},bottomViewHeight:{type:Number,default:300},isPanelDragging:{type:Boolean,default:!1}},emits:["update:activeBottomTab","highlight-on-map","show-service-point-detail","reset-view"],setup(e){const t=(0,c.KR)(null);return(0,i.wB)((()=>e.activeBottomTab),(()=>{(0,i.dY)((()=>{console.log(`✅ 底部分頁已切換至: ${e.activeBottomTab}`)}))})),{bottomTabContentRef:t}}};const go=(0,u.A)(yo,[["render",Xr]]);var ho=go;const fo={class:"d-flex flex-column overflow-hidden h-100"};var bo={__name:"MiddleView",props:{activeUpperTab:{type:String,default:"map"},activeBottomTab:{type:String,default:"table"},mainPanelWidth:{type:Number,default:60},dynamicMainAreaHeight:{type:Number,default:500},showTainanLayer:{type:Boolean,default:!1},selectedFilter:{type:String,default:""},zoomLevel:{type:Number,default:11},currentCoords:{type:Object,default:()=>({lat:25.033,lng:121.5654})},activeMarkers:{type:Number,default:0},isSidePanelDragging:{type:Boolean,default:!1}},emits:["update:activeUpperTab","update:activeBottomTab","update:zoomLevel","update:currentCoords","update:activeMarkers","update:tableSearchQuery","sort-table","highlight-on-map","show-service-point-detail","reset-view"],setup(e,{expose:t}){const a=e,r=(0,c.KR)(null),o=(0,c.KR)(30),l=(0,c.KR)(!1),s=(0,i.EW)((()=>a.isSidePanelDragging||l.value)),n=(0,i.EW)((()=>{const e=a.dynamicMainAreaHeight;return console.log(`🔧 MiddleView: middleSectionTotalHeight (from prop): ${e}`),Math.max(e,0)})),d=(0,i.EW)((()=>{const e=o.value/100*n.value;return console.log(`🔧 MiddleView: actualBottomViewPixelHeight calculated: ${e} (percent: ${o.value}%, totalMiddle: ${n.value})`),e})),u=(0,i.EW)((()=>{const e=n.value-d.value;return console.log(`🔧 MiddleView: contentHeight (for MainContent) calculated: ${e}, totalMiddle: ${n.value}, bottomViewPx: ${d.value}`),e})),p=e=>{e.preventDefault(),e.stopPropagation(),l.value=!0,document.body.classList.add("my-no-select");const t=e.clientY,a=o.value,r=n.value,i=e=>{e.preventDefault();const i=e.clientY-t;if(0===r)return;const l=i/r*100;let s=a-l;s=Math.max(0,Math.min(100,s)),o.value=Math.round(10*s)/10},s=()=>{l.value=!1,document.body.classList.remove("my-no-select"),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",s)};(0,i.wB)((()=>a.activeUpperTab),((e,t)=>{console.log(`🔧 MiddleView Watcher: activeUpperTab changed from "${t}" to "${e}". Current bottomViewHeightPercent: ${o.value}%`)})),(0,i.sV)((()=>{console.log("🚀 MiddleView mounted")})),(0,i.hi)((()=>{console.log("🗑️ MiddleView unmounted")}));const v=e=>{r.value?(console.log("🎯 MiddleView: 呼叫 highlightFeature",e),r.value.highlightFeature(e)):console.warn("⚠️ 無法高亮顯示：mainContentRef 未定義")},m=()=>{r.value&&(console.log("🗺️ MiddleView: 呼叫 fitToTainanBounds"),r.value.fitToTainanBounds())},g=()=>{r.value&&(console.log("🔄 MiddleView: 呼叫 resetMapTab"),r.value.resetView())},h=()=>{r.value&&(console.log("📏 MiddleView: 呼叫地圖尺寸刷新"),r.value.invalidateMapSize())},f=()=>{r.value&&(console.log("🔄 MiddleView: 呼叫地圖重試初始化"),r.value.retryMapInitialization())},b=()=>r.value?r.value.getMapInitStatus():"not-applicable",L=()=>{r.value&&(console.log("🛑 MiddleView: 停止地圖點擊模式"),r.value.stopMapClickMode())};return t({highlightFeature:v,fitToTainanBounds:m,resetMapTab:g,invalidateMapSize:h,retryMapInitialization:f,getMapInitStatus:b,stopMapClickMode:L}),(t,a)=>((0,i.uX)(),(0,i.CE)("div",fo,[(0,i.Lk)("div",{style:(0,y.Tr)({pointerEvents:s.value?"none":"auto",height:u.value+"px",overflow:"hidden"})},[(0,i.bF)(Ar,{ref_key:"mainContentRef",ref:r,activeUpperTab:e.activeUpperTab,mainPanelWidth:e.mainPanelWidth,contentHeight:u.value,showTainanLayer:e.showTainanLayer,selectedFilter:e.selectedFilter,zoomLevel:e.zoomLevel,isPanelDragging:s.value,activeMarkers:e.activeMarkers,"onUpdate:activeUpperTab":a[0]||(a[0]=e=>t.$emit("update:activeUpperTab",e)),"onUpdate:zoomLevel":a[1]||(a[1]=e=>t.$emit("update:zoomLevel",e)),"onUpdate:currentCoords":a[2]||(a[2]=e=>t.$emit("update:currentCoords",e)),"onUpdate:activeMarkers":a[3]||(a[3]=e=>t.$emit("update:activeMarkers",e)),onShowServicePointDetail:a[4]||(a[4]=e=>t.$emit("show-service-point-detail",e))},null,8,["activeUpperTab","mainPanelWidth","contentHeight","showTainanLayer","selectedFilter","zoomLevel","isPanelDragging","activeMarkers"])],4),(0,i.Lk)("div",{class:(0,y.C4)(["my-resizer my-resizer-horizontal my-resizer-middle",{"my-dragging":l.value}]),onMousedown:p,title:"拖曳調整底部面板高度"},null,34),(0,i.Lk)("div",{class:"overflow-hidden",style:(0,y.Tr)({pointerEvents:s.value?"none":"auto",height:d.value+"px"})},[(0,i.bF)(ho,{activeBottomTab:e.activeBottomTab,bottomViewHeight:d.value,isPanelDragging:s.value,"onUpdate:activeBottomTab":a[5]||(a[5]=e=>t.$emit("update:activeBottomTab",e)),onHighlightOnMap:a[6]||(a[6]=e=>t.$emit("highlight-on-map",e)),onShowServicePointDetail:a[7]||(a[7]=e=>t.$emit("show-service-point-detail",e)),onResetView:a[8]||(a[8]=e=>t.$emit("reset-view"))},null,8,["activeBottomTab","bottomViewHeight","isPanelDragging"])],4)]))}};const Lo=bo;var wo=Lo;const ko={class:"d-flex flex-column h-100 my-bgcolor-gray-200"},xo={class:"flex-grow-1 overflow-hidden",style:{"padding-bottom":"70px"}},Co={class:"h-100"},_o={class:"h-100"},So={class:"h-100"},To=["onClick"],Po={class:"d-flex flex-column align-items-center justify-content-center w-100"},Io={class:"my-font-size-sm"},Mo={class:"my-font-size-xs"};function Do(e,t,a,o,l,s){const n=(0,i.g2)("DateLayersTab"),c=(0,i.g2)("DataTableTab"),d=(0,i.g2)("PropertiesTab");return(0,i.uX)(),(0,i.CE)("div",ko,[(0,i.Lk)("div",xo,[(0,i.bo)((0,i.Lk)("div",Co,[(0,i.bF)(n)],512),[[r.aG,"layers"===a.activeTab]]),(0,i.bo)((0,i.Lk)("div",_o,[(0,i.bF)(c,{onHighlightOnMap:t[0]||(t[0]=t=>e.$emit("highlight-on-map",t)),onShowServicePointDetail:t[1]||(t[1]=t=>e.$emit("show-service-point-detail",t))})],512),[[r.aG,"table"===a.activeTab]]),(0,i.bo)((0,i.Lk)("div",So,[(0,i.bF)(d,{onHighlightFeature:t[2]||(t[2]=t=>e.$emit("highlight-feature",t))})],512),[[r.aG,"properties"===a.activeTab]])]),(0,i.Lk)("div",{class:"position-fixed bottom-0 start-0 end-0 d-flex align-items-center justify-content-between my-bgcolor-gray-200 border-top z-100 w-100",style:(0,y.Tr)(o.getBottomNavStyle)},[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(o.availableTabs,(e=>((0,i.uX)(),(0,i.CE)("button",{key:e.id,class:(0,y.C4)(["d-flex rounded-3 border-0 flex-grow-1 py-2 mx-1",{"my-btn-transparent":a.activeTab!==e.id,"my-btn-blue":a.activeTab===e.id}]),style:{"min-height":"44px","touch-action":"manipulation","-webkit-appearance":"none !important"},onClick:t=>o.switchTab(e.id)},[(0,i.Lk)("div",Po,[(0,i.Lk)("span",Io,[(0,i.Lk)("i",{class:(0,y.C4)([e.icon,"mb-1"])},null,2)]),(0,i.Lk)("span",Mo,(0,y.v_)(e.name),1)])],10,To)))),128))],4)])}var Eo={name:"ResponsiveLowerView",components:{DateLayersTab:Ye,DataTableTab:mo,PropertiesTab:Fa},props:{activeTab:{type:String,default:"layers"},activeRightTab:{type:String,default:"properties"},activeBottomTab:{type:String,default:"table"}},emits:["update:activeTab","update:activeRightTab","update:activeBottomTab","highlight-on-map","highlight-feature","show-service-point-detail"],setup(e,{emit:t}){const a=(0,c.KR)(0),r=(0,i.EW)((()=>[{id:"layers",name:"圖層",icon:"fas fa-layer-group"},{id:"table",name:"資料表",icon:"fas fa-table"},{id:"properties",name:"屬性",icon:"fa-solid fa-location-dot"}])),o=()=>{const e=window.innerHeight,t=window.visualViewport?.height||e,r=e-t;a.value=r>0?r:0},l=(0,i.EW)((()=>{const e=60,t=a.value>0?a.value+10:10;return{"min-height":`${e}px`,height:`${e+t}px`,padding:`8px 4px ${t}px 4px`}})),s=e=>{t("update:activeTab",e)};return(0,i.sV)((()=>{o(),window.addEventListener("resize",o),window.visualViewport&&(window.visualViewport.addEventListener("resize",o),window.visualViewport.addEventListener("scroll",o)),window.addEventListener("orientationchange",(()=>{setTimeout(o,300)}))})),(0,i.hi)((()=>{window.removeEventListener("resize",o),window.visualViewport&&(window.visualViewport.removeEventListener("resize",o),window.visualViewport.removeEventListener("scroll",o)),window.removeEventListener("orientationchange",o)})),{availableTabs:r,switchTab:s,getBottomNavStyle:l,bottomSafeArea:a}}};const $o=(0,u.A)(Eo,[["render",Do]]);var Fo=$o,zo={name:"HomeView",components:{LoadingOverlay:X,LeftView:Nt,RightView:Va,MiddleView:wo,UpperView:Ar,ResponsiveLowerView:Fo},setup(){const e=_(),t=(0,c.KR)([]),a=(0,c.KR)(null),r=(0,c.KR)(null),o=(0,c.KR)(null),l=(0,c.KR)("map"),s=(0,c.KR)("table"),n=(0,c.KR)("properties"),d=(0,c.KR)("layers"),u=5,p=(0,c.KR)(20),v=(0,c.KR)(20),m=(0,c.KR)(window.innerWidth),y=(0,c.KR)(window.innerHeight),g=(0,c.KR)(0),h=(0,i.EW)((()=>`${p.value}%`)),f=(0,i.EW)((()=>`${v.value}%`)),b=(0,i.EW)((()=>100-p.value-v.value)),L=(0,i.EW)((()=>`${b.value}%`)),w=(0,i.EW)((()=>y.value-g.value)),k=(0,c.KR)("載入中..."),x=(0,c.KR)(0),C=(0,c.KR)(!1),S=(0,c.KR)(""),T=(0,i.EW)((()=>e.getAllLayers().some((e=>e.isLoading))));(0,i.wB)(T,(t=>{if(t){const t=e.getAllLayers().find((e=>e.isLoading));k.value=`載入 ${t.layerName} 數據中...`,S.value="正在處理地理資訊..."}else k.value="載入完成",S.value="數據已更新"}),{deep:!0});const P=(0,i.EW)((()=>e.findLayerById("tainan")?.visible||!1)),I=(0,c.KR)(null),M=(0,c.KR)(11),D=(0,c.KR)({lat:25.033,lng:121.5654}),E=(0,c.KR)(0),$=(0,c.KR)(null),F=(0,c.KR)(!1),z=()=>{a.value&&a.value.resetMapTab()},N=(e,t)=>{t.preventDefault(),t.stopPropagation(),F.value=!0,document.body.classList.add("my-no-select");const a=t.clientX,r=p.value,o=v.value,i=m.value;console.log(`🔧 開始調整 ${e} 方向，初始值:`,{leftWidth:r,rightWidth:o});const l=t=>{t.preventDefault();const l=t.clientX-a,s=l/i*100;if("left"===e){let e=r+s;e=Math.max(u,Math.min(100-v.value,e)),p.value=e}else if("right"===e){let e=o-s;e=Math.max(0,Math.min(100-p.value,e)),v.value=e}},s=()=>{F.value=!1,document.body.classList.remove("my-no-select"),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",s),V(),console.log("✅ 拖曳調整完成，最終值:",{leftWidth:p.value,rightWidth:v.value,mainWidth:b.value})};document.addEventListener("mousemove",l),document.addEventListener("mouseup",s)},V=()=>{p.value=Math.max(u,Math.min(100,p.value)),v.value=Math.max(0,Math.min(100,v.value)),p.value=Math.round(10*p.value)/10,v.value=Math.round(10*v.value)/10},A=()=>{const e=m.value,t=e>=1200;m.value=window.innerWidth,y.value=window.innerHeight;const l=window.innerWidth>=1200;t!==l?(console.log("🔄 HomeView: 響應式斷點切換 "+(t?"桌面版→響應式":"響應式→桌面版")),G()):(0,i.dY)((()=>{setTimeout((()=>{l&&a.value?a.value.invalidateMapSize&&a.value.invalidateMapSize():!l&&r.value&&r.value.invalidateMapSize&&r.value.invalidateMapSize()}),100)})),(0,i.dY)((()=>{if(o.value&&window.innerWidth>=1200?g.value=o.value.offsetHeight:g.value=0,!l){const e=H();U.value<e&&(U.value=Math.round(e),console.log(`🔧 HomeView: 視窗大小變化，調整底部面板最小高度至 ${U.value}vh`))}}))};(0,i.sV)((()=>{console.log("🚀 空間分析平台已初始化"),window.addEventListener("resize",A),(0,i.dY)((()=>{o.value&&window.innerWidth>=1200?g.value=o.value.offsetHeight:g.value=0})),window.ResizeObserver&&(Y=new ResizeObserver((e=>{for(let t of e){const{width:e}=t.contentRect,a=e>=1200,r=t.target.classList.contains("xl-and-above");a!==r&&(t.target.classList.toggle("xl-and-above",a),G())}})),Y.observe(document.body))}));const R=e=>{E.value=e},W=()=>{a.value&&a.value.retryMapInitialization()},X=()=>a.value?a.value.getMapInitStatus():"not-available",B=e=>{console.log("🎯 HomeView 處理高亮顯示:",e),"map"!==l.value&&(l.value="map"),(0,i.dY)((()=>{const t=window.innerWidth>=1200;t?a.value?a.value.highlightFeature(e):console.error("❌ 無法高亮顯示: middlePanelRef 不可用"):r.value?r.value.highlightFeature(e):console.error("❌ 無法高亮顯示: mobileUpperViewRef 不可用")}))},K=t=>{if(console.log("📋 [3] HomeView: 開始處理 service point detail",t),"service-items"===t.type){console.log(">> [3a] HomeView: 檢測到 `service-items` 類型");const a={type:"Feature",properties:{...t.servicePoint,serviceItems:t.serviceItems,servicePointInfo:t.servicePointInfo,type:"service-items",layerId:t.layerId,layerName:t.layerName}};console.log(">> [4] HomeView: 創建的 serviceItemsFeature",a),e.setSelectedFeature(a),console.log(">> [5] HomeView: 已在 dataStore 中設定 selectedFeature");const r=window.innerWidth>=1200;r?(n.value="properties",0===v.value&&(v.value=20),console.log(">> [6] HomeView: 已切換到桌面版右側屬性面板")):(d.value="properties",U.value<30&&(U.value=40),console.log(">> [6] HomeView: 已切換到行動版下方屬性面板"))}else console.log(">> [3b] HomeView: 處理非 `service-items` 類型"),$.value=t,0===p.value&&(p.value=20)},O=()=>{console.log("📋 HomeView 清除服務點詳細資訊"),$.value=null},H=()=>{const e=100,t=window.innerHeight;return Math.max(10,e/t*100)},U=(0,c.KR)(Math.max(40,H())),j=(0,c.KR)(!1),J=(0,c.KR)(0),Q=e=>{e.preventDefault(),e.stopPropagation(),j.value=!0,document.body.classList.add("my-no-select");const t=e.type.startsWith("touch"),a=t?e.touches[0].clientY:e.clientY,r=a,o=U.value,i=window.innerHeight;console.log("🔧 HomeView - 開始垂直調整",{startY:r,startBottomHeight:o,windowHeight:i,isTouch:t});const l=e=>{e.preventDefault();const t=e.type.startsWith("touch")?e.touches[0].clientY:e.clientY,a=t-r,l=a/i*100;let s=o-l;const n=H();s=Math.max(n,Math.min(100,s)),U.value=Math.round(s)},s=()=>{j.value=!1,document.body.classList.remove("my-no-select"),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",s),document.removeEventListener("touchmove",l),document.removeEventListener("touchend",s),document.removeEventListener("touchcancel",s),console.log("🔧 HomeView - 垂直調整結束",{finalHeight:U.value})};t?(document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("touchend",s),document.addEventListener("touchcancel",s)):(document.addEventListener("mousemove",l),document.addEventListener("mouseup",s))};(0,i.wB)(y,(()=>{setTimeout((()=>{J.value+=1}),100)}));const G=()=>{console.log("🔄 HomeView: 螢幕尺寸跨越斷點，重新初始化地圖"),J.value+=1,(0,i.dY)((()=>{setTimeout((()=>{const e=window.innerWidth>=1200;e?a.value&&(console.log("🖥️ HomeView: 切換到桌面版，處理 MiddleView 地圖"),a.value.invalidateMapSize&&a.value.invalidateMapSize(),setTimeout((()=>{const e=new Event("resize");window.dispatchEvent(e)}),100)):r.value&&(console.log("📱 HomeView: 切換到響應式版本，處理 UpperView 地圖"),r.value.invalidateMapSize&&r.value.invalidateMapSize())}),300)}))};let Y=null;return(0,i.hi)((()=>{window.removeEventListener("resize",A),Y&&Y.disconnect()})),{middlePanelRef:a,activeUpperTab:l,activeBottomTab:s,activeRightTab:n,activeLowerTab:d,isAnyLayerLoading:T,loadingText:k,loadingProgress:x,showLoadingProgress:C,loadingSubText:S,showTainanLayer:P,selectedFilter:I,zoomLevel:M,currentCoords:D,activeMarkers:E,leftViewWidth:p,rightViewWidth:v,leftViewWidthPx:h,rightViewWidthPx:f,mainPanelWidth:b,mainPanelWidthPx:L,tableData:t,resetView:z,startResize:N,startVerticalResize:Q,isSidePanelDragging:F,isVerticalDragging:j,mobileBottomViewHeight:U,mobileMapKey:J,validatePanelSizes:V,appFooterRef:o,mobileUpperViewRef:r,calculatedMiddleViewHeight:w,handleHighlight:B,handleShowServicePointDetail:K,handleClearServicePointDetail:O,selectedServicePoint:$,updateActiveMarkers:R,retryMapInitialization:W,getMapInitStatus:X}}};const No=(0,u.A)(zo,[["render",x]]);var Vo=No;const Ao=[{path:"/",name:"Home",component:Vo}],Ro=(0,m.aE)({history:(0,m.LA)("/long-term-care-web-taichung/"),routes:Ao});var Wo=Ro;a(323);console.log("🎨 樣式文件載入完成");const Xo=(0,r.Ef)(v),Bo=(0,o.Ey)();Xo.use(Wo),Xo.use(Bo),Xo.mount("#app"),console.log("🚀 空間分析視覺化平台已啟動"),console.log("📦 Pinia 狀態管理已初始化"),console.log("🗺️ Vue Router 路由系統已就緒"),console.log("🎨 Bootstrap 5 UI 框架已載入"),console.log("🗺️ Leaflet 地圖庫已準備就緒"),console.log("🔤 Font Awesome 圖示庫已載入")}},t={};function a(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,a),i.exports}a.m=e,function(){var e=[];a.O=function(t,r,o,i){if(!r){var l=1/0;for(d=0;d<e.length;d++){r=e[d][0],o=e[d][1],i=e[d][2];for(var s=!0,n=0;n<r.length;n++)(!1&i||l>=i)&&Object.keys(a.O).every((function(e){return a.O[e](r[n])}))?r.splice(n--,1):(s=!1,i<l&&(l=i));if(s){e.splice(d--,1);var c=o();void 0!==c&&(t=c)}}return t}i=i||0;for(var d=e.length;d>0&&e[d-1][2]>i;d--)e[d]=e[d-1];e[d]=[r,o,i]}}(),function(){a.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return a.d(t,{a:t}),t}}(),function(){a.d=function(e,t){for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}}(),function(){a.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){var e={524:0};a.O.j=function(t){return 0===e[t]};var t=function(t,r){var o,i,l=r[0],s=r[1],n=r[2],c=0;if(l.some((function(t){return 0!==e[t]}))){for(o in s)a.o(s,o)&&(a.m[o]=s[o]);if(n)var d=n(a)}for(t&&t(r);c<l.length;c++)i=l[c],a.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return a.O(d)},r=self["webpackChunklong_term_care_web_taichung"]=self["webpackChunklong_term_care_web_taichung"]||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))}();var r=a.O(void 0,[504],(function(){return a(4434)}));r=a.O(r)})();
//# sourceMappingURL=app.38e46a30.js.map